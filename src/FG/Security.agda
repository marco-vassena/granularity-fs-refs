-- This module proves security of FG, i.e., termination-insensitive
-- non-interference (TINI).  The proof consists in showing that the
-- big-step semantics preserves L-equivalence.
--
-- This module is parametric in the security lattice ğ‘³ = (ğ“›, âŠ‘) and in
-- the attacker's security A âˆˆ ğ“›.

open import Lattice hiding (_â‰Ÿ_)

module FG.Security {{ğ‘³ : Lattice}} (A : Label) where

open import FG.Types hiding (_Ã—_) renaming (_âŠ†_ to _âŠ†á¶œ_) hiding (refl-âŠ†)
open import FG.Syntax hiding (_âˆ˜_ )
open import FG.Semantics
open import FG.LowEq A public

open import Data.Empty
open import Relation.Binary.PropositionalEquality
open import Relation.Nullary
open import Generic.Bijection as B hiding (_âˆˆ_)

import Generic.Store.LowEq {Ty} {Raw} _â‰ˆâŸ¨_âŸ©á´¿_ as S

--------------------------------------------------------------------------------
-- TODO: move this to.FG LowEq module?
-- Lemmas on L-equivalent environments.

-- Lookup in L-equivalent envs gives L-equivalent values
lookup-â‰ˆâ±½ : âˆ€ {Ï„ Î“ Î¸â‚ Î¸â‚‚ Î²} â†’ (Ï„âˆˆÎ“ : Ï„ âˆˆ Î“) â†’
              Î¸â‚ â‰ˆâŸ¨ Î² âŸ©á´± Î¸â‚‚ â†’ (Î¸â‚ !! Ï„âˆˆÎ“) â‰ˆâŸ¨ Î² âŸ©â±½ (Î¸â‚‚ !! Ï„âˆˆÎ“)
lookup-â‰ˆâ±½ here (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚) = vâ‚â‰ˆvâ‚‚
lookup-â‰ˆâ±½ (there Ï„âˆˆÎ“) (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚) = lookup-â‰ˆâ±½ Ï„âˆˆÎ“ Î¸â‚â‰ˆÎ¸â‚‚


-- Slicing L-equivalent envs gives gives L-equivalent envs.
slice-â‰ˆá´± : âˆ€ {Î“â‚ Î“â‚‚ Î²} {Î¸â‚ Î¸â‚‚ : Env Î“â‚‚} â†’
                 Î¸â‚ â‰ˆâŸ¨ Î² âŸ©á´± Î¸â‚‚ â†’
                 (Î“â‚âŠ†Î“â‚‚ : Î“â‚ âŠ†á¶œ Î“â‚‚) â†’
                 slice Î¸â‚ Î“â‚âŠ†Î“â‚‚ â‰ˆâŸ¨ Î² âŸ©á´± slice Î¸â‚‚ Î“â‚âŠ†Î“â‚‚
slice-â‰ˆá´± [] base = []
slice-â‰ˆá´± (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚) (cons p) = vâ‚â‰ˆvâ‚‚ âˆ· slice-â‰ˆá´± Î¸â‚â‰ˆÎ¸â‚‚ p
slice-â‰ˆá´± (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚) (drop p) = slice-â‰ˆá´± Î¸â‚â‰ˆÎ¸â‚‚ p

--------------------------------------------------------------------------------

open import Data.Product renaming (_,_ to _âˆ§_) hiding (,_)

open import FG.Valid

open Conf
open import Data.Nat hiding (_^_)
open import Data.Nat.Properties

import Generic.Heap.Lemmas Ty Value as H

-- TODO: trans-â‹¤ (join-âŠ‘ ...) proofs are simplified by join-â‹¤â‚

-- TODO: rename high step
step-â‰ˆá´´ : âˆ€ {Ï„ Î“ Î¸ pc} {c : IConf Î“ Ï„} {c' : FConf Ï„} â†’
             let âŸ¨ Î£ , Î¼ , _ âŸ© = c
                 âŸ¨ Î£' , Î¼' , _ âŸ© = c' in
                 {{validá´¾ : Validá´¾ âŸ¨ Î£ , Î¼ âŸ© }} {{validá´± : Validá´± âˆ¥ Î¼ âˆ¥á´´ Î¸}} â†’
               c â‡“âŸ¨ Î¸ , pc âŸ© c' â†’
               pc â‹¤ A â†’
               âŸ¨ Î£ , Î¼ âŸ© â‰ˆâŸ¨ Î¹ âˆ¥ Î¼ âˆ¥á´´ âŸ©á´¾ âŸ¨ Î£' , Î¼' âŸ©

step-â‰ˆá´´ (Var Ï„âˆˆÎ“ x) pcâ‹¤A = refl-â‰ˆá´¾

step-â‰ˆá´´ Unit pcâ‹¤A = refl-â‰ˆá´¾

step-â‰ˆá´´ (Lbl â„“) pcâ‹¤A = refl-â‰ˆá´¾

step-â‰ˆá´´ {{isVá´¾}} {{isVá´±}} (Testâ‚ x xâ‚ â„“âŠ‘ refl) pcâ‹¤A =
  let _ âˆ§ isVá´¾â€² âˆ§ _ = valid-invariant x âŸ¨ isVá´¾ , isVá´± âŸ©
      Î¼âŠ†Î¼â‚ = step-â‰ˆá´´ x pcâ‹¤A
      Î¼â‚âŠ†Î¼â‚‚ = step-â‰ˆá´´ {{ isVá´¾â€²}} xâ‚ pcâ‹¤A
  in trans-â‰ˆá´¾-Î¹ Î¼âŠ†Î¼â‚ Î¼â‚âŠ†Î¼â‚‚

step-â‰ˆá´´ {{isVá´¾}} {{isVá´±}} (Testâ‚‚ x xâ‚ â„“âŠ‘ refl) pcâ‹¤A =
  let _ âˆ§ isVá´¾â€² âˆ§ isVá´±â€² = valid-invariant x âŸ¨ isVá´¾ , isVá´± âŸ©
      Î¼âŠ†Î¼â‚ = step-â‰ˆá´´ x pcâ‹¤A
      Î¼â‚âŠ†Î¼â‚‚ = step-â‰ˆá´´ {{ isVá´¾â€² }} xâ‚ pcâ‹¤A
  in trans-â‰ˆá´¾-Î¹ Î¼âŠ†Î¼â‚ Î¼â‚âŠ†Î¼â‚‚

step-â‰ˆá´´ Fun pcâ‹¤A = refl-â‰ˆá´¾

step-â‰ˆá´´ {{isVá´¾}} {{isVá´±}} (App {Î¸' = Î¸'} xâ‚ xâ‚‚ refl xâ‚ƒ) pcâ‹¤A =
  let isVâ‚á´± âˆ§ isVá´¾â€² âˆ§ isVá´±â€² = valid-invariant xâ‚ âŸ¨ isVá´¾ , isVá´± âŸ©
      _ âˆ§ isVá´¾â€²â€² âˆ§ isVâ±½ = valid-invariant xâ‚‚ âŸ¨ isVá´¾â€² , isVâ‚á´± âŸ©
      Î¼âŠ†Î¼â‚ = step-â‰ˆá´´ xâ‚ pcâ‹¤A
      Î¼â‚âŠ†Î¼â‚‚ = step-â‰ˆá´´ {{ isVá´¾â€² }} {{ isVá´± }} xâ‚‚ pcâ‹¤A
      isVá´±â€²â€² = validá´±-âŠ†á´´ {Î¸ = Î¸'} (step-âŠ†á´´ xâ‚‚) isVá´±â€²
      Î¼â‚‚âŠ†Î¼â‚ƒ = step-â‰ˆá´´ {{ isVá´¾â€²â€² }} {{  isVâ±½ âˆ§ isVá´±â€²â€²  }} xâ‚ƒ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤A)
  in trans-â‰ˆá´¾-Î¹ Î¼âŠ†Î¼â‚ (trans-â‰ˆá´¾-Î¹ Î¼â‚âŠ†Î¼â‚‚ Î¼â‚‚âŠ†Î¼â‚ƒ)

step-â‰ˆá´´ {{isVá´¾}} {{isVá´±}} (Wken {Î¼ = Î¼} p x) pcâ‹¤A = step-â‰ˆá´´ {{ isVá´¾ }} {{ validá´±-âŠ†á¶œ {Î¼ = Î¼} p isVá´± }} x pcâ‹¤A

step-â‰ˆá´´ (Inl x) pcâ‹¤A = step-â‰ˆá´´ x pcâ‹¤A

step-â‰ˆá´´ (Inr x) pcâ‹¤A = step-â‰ˆá´´ x pcâ‹¤A

step-â‰ˆá´´ {{isVá´¾}} {{isVá´±}} (Caseâ‚ xâ‚ refl xâ‚‚) pcâ‹¤A =
  let isVá´±â€² âˆ§ isVá´¾â€² âˆ§ isVâ±½ = valid-invariant xâ‚ âŸ¨ isVá´¾ , isVá´± âŸ©
      Î¼âŠ†Î¼â‚ = step-â‰ˆá´´ xâ‚ pcâ‹¤A
      Î¼â‚âŠ†Î¼â‚‚ = step-â‰ˆá´´ {{ isVá´¾â€² }} {{ isVâ±½ âˆ§ isVá´±â€² }} xâ‚‚ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤A)
  in trans-â‰ˆá´¾-Î¹ Î¼âŠ†Î¼â‚ Î¼â‚âŠ†Î¼â‚‚

step-â‰ˆá´´ {{isVá´¾}} {{isVá´±}} (Caseâ‚‚ x refl xâ‚) pcâ‹¤A =
  let isVá´±â€² âˆ§ isVá´¾â€² âˆ§ isVâ±½ = valid-invariant x âŸ¨ isVá´¾ , isVá´± âŸ©
      Î¼âŠ†Î¼â‚ = step-â‰ˆá´´ x pcâ‹¤A
      Î¼â‚âŠ†Î¼â‚‚ = step-â‰ˆá´´ {{ isVá´¾â€² }} {{ isVâ±½ âˆ§ isVá´±â€² }} xâ‚ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤A)
  in trans-â‰ˆá´¾-Î¹ Î¼âŠ†Î¼â‚ Î¼â‚âŠ†Î¼â‚‚

step-â‰ˆá´´ {{isVá´¾}} {{isVá´±}} (Pair x xâ‚) pcâ‹¤A =
  let _ âˆ§ isVá´¾â€² âˆ§ _ = valid-invariant x âŸ¨ isVá´¾ , isVá´± âŸ©
      Î¼âŠ†Î¼â‚ = step-â‰ˆá´´ x pcâ‹¤A
      Î¼â‚âŠ†Î¼â‚‚ = step-â‰ˆá´´ {{ isVá´¾â€² }} xâ‚ pcâ‹¤A
  in trans-â‰ˆá´¾-Î¹ Î¼âŠ†Î¼â‚ Î¼â‚âŠ†Î¼â‚‚

step-â‰ˆá´´ (Fst x refl) pcâ‹¤A = step-â‰ˆá´´ x pcâ‹¤A

step-â‰ˆá´´ (Snd x xâ‚) pcâ‹¤A = step-â‰ˆá´´ x pcâ‹¤A

step-â‰ˆá´´ (LabelOf x) pcâ‹¤A = step-â‰ˆá´´ x pcâ‹¤A

step-â‰ˆá´´ GetLabel pcâ‹¤A = refl-â‰ˆá´¾

step-â‰ˆá´´ {{ isVá´¾ }} {{isVá´±}} (Taint refl x xâ‚ pc'âŠ‘pc'') pcâ‹¤A =
  let isVá´±â€² âˆ§ isVá´¾â€² âˆ§ _ = valid-invariant x âŸ¨ isVá´¾ , isVá´± âŸ©
      Î¼âŠ†Î¼â‚ = step-â‰ˆá´´ x pcâ‹¤A
      Î¼â‚âŠ†Î¼â‚‚ = step-â‰ˆá´´ {{ isVá´¾â€² }} {{ isVá´±â€² }} xâ‚ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤A)
  in trans-â‰ˆá´¾-Î¹ Î¼âŠ†Î¼â‚ Î¼â‚âŠ†Î¼â‚‚

step-â‰ˆá´´ (LabelOfRef x eq) pcâ‹¤A = step-â‰ˆá´´ x pcâ‹¤A

step-â‰ˆá´´ {{isVá´¾}} {{isVá´±}} (New {Î¼ = Î¼} {Î¼'} x) pcâ‹¤A =
  let âŸ¨ â‰ˆË¢ , â‰ˆá´´ âŸ© = step-â‰ˆá´´ x pcâ‹¤A
      _ âˆ§ âŸ¨ isVË¢â€² , isVá´´â€² âŸ© âˆ§ _ = valid-invariant x âŸ¨ isVá´¾ , isVá´± âŸ©
      â‰ˆË¢â€² = updateá´´-â‰ˆË¢ _ _ {{ isVË¢â€² }} (trans-â‹¤ (step-âŠ‘ x) pcâ‹¤A) in
      âŸ¨ trans-â‰ˆË¢-Î¹ {nâ‚ = âˆ¥ Î¼ âˆ¥á´´} {nâ‚‚ = âˆ¥ Î¼' âˆ¥á´´} â‰ˆË¢ â‰ˆË¢â€² , â‰ˆá´´ âŸ©

step-â‰ˆá´´ (Read x xâ‚ eq) pcâ‹¤A = step-â‰ˆá´´ x pcâ‹¤A

step-â‰ˆá´´ {{isVá´¾}} {{isVá´±}} (Write {â„“ = â„“} {n = n} {Ï„ = Ï„} x âŠ‘â‚ xâ‚ âŠ‘â‚‚ w) pcâ‹¤A =
  let isVá´±â€² âˆ§ isVá´¾â€² âˆ§ _ = valid-invariant x âŸ¨ isVá´¾ , isVá´± âŸ©
      _ âˆ§ âŸ¨ isVË¢â€² , isVá´´â€² âŸ© âˆ§ _ = valid-invariant xâ‚ âŸ¨ isVá´¾â€² , isVá´± âŸ©
      Î¼âŠ†Î¼â‚ = step-â‰ˆá´´ x pcâ‹¤A
      Î¼â‚âŠ†Î¼â‚‚ = step-â‰ˆá´´ {{ isVá´¾â€² }} xâ‚ pcâ‹¤A
      â„“â‹¤A = trans-â‹¤ (trans-âŠ‘ (step-âŠ‘ x) âŠ‘â‚) pcâ‹¤A
      Î¼â‚‚â‰ˆÎ¼â‚ƒ = âŸ¨ updateá´´-â‰ˆË¢ _ _ {{ isVË¢â€² }} â„“â‹¤A , refl-â‰ˆá´´ {{ isVá´´â€² }} âŸ©
  in trans-â‰ˆá´¾-Î¹ Î¼âŠ†Î¼â‚ (trans-â‰ˆá´¾-Î¹ Î¼â‚âŠ†Î¼â‚‚ Î¼â‚‚â‰ˆÎ¼â‚ƒ)

step-â‰ˆá´´ (LabelOfRef-FS x xâ‚ eq) pcâ‹¤A = step-â‰ˆá´´ x pcâ‹¤A

step-â‰ˆá´´ {{âŸ¨ isVË¢ , isVá´´ âŸ©}} {{isVá´±}} (New-FS {Î£ = Î£} {Î£' = Î£'} {Î¼ = Î¼} {Î¼' = Î¼'} {v = v} x) pcâ‹¤A =
  let âŸ¨ â‰ˆË¢ , â‰ˆá´´ âŸ© = step-â‰ˆá´´ {{ âŸ¨ isVË¢ , isVá´´ âŸ© }} {{isVá´±}} x pcâ‹¤A
      _ âˆ§ âŸ¨ isVË¢â€² , isVá´´â€² âŸ© âˆ§ _ = valid-invariant x âŸ¨ âŸ¨ isVË¢ , isVá´´ âŸ© , isVá´± âŸ©
      â‰ˆË¢â€² = trans-â‰ˆË¢-Î¹ {Î£â‚ = Î£} {Î£â‚‚ = Î£'} {Î£â‚ƒ = Î£'} {nâ‚ = âˆ¥ Î¼ âˆ¥á´´} {nâ‚‚ = âˆ¥ Î¼' âˆ¥á´´} â‰ˆË¢ (refl-â‰ˆË¢ {{ isVË¢â€² }}) in
      âŸ¨ â‰ˆË¢â€² , snoc-â‰ˆá´´ _ â‰ˆá´´ âŸ©

step-â‰ˆá´´ (Read-FS x xâ‚ eq) pcâ‹¤A = step-â‰ˆá´´ x pcâ‹¤A

step-â‰ˆá´´ {{isVá´¾}} {{isVá´±}} (Write-FS {â„“ = â„“} {â„“â‚} {â„“â‚‚} {â„“â‚‚'} x xâ‚ âˆˆâ‚ âŠ‘â‚ refl w) pcâ‹¤A =
  let isVá´±â€² âˆ§ isVá´¾â€² âˆ§ _ = valid-invariant x âŸ¨ isVá´¾ , isVá´± âŸ©
      isVá´±â€²â€² âˆ§ isVá´¾â€²â€² âˆ§ _ = valid-invariant xâ‚ âŸ¨ isVá´¾â€² , isVá´±â€² âŸ©
      Î¼âŠ†Î¼â‚ = step-â‰ˆá´´ x pcâ‹¤A
      Î¼â‚âŠ†Î¼â‚‚ = step-â‰ˆá´´ {{ isVá´¾â€² }} {{ isVá´±â€² }} xâ‚ pcâ‹¤A
      vâ‰ˆ = Valueá´´ (trans-â‹¤ (trans-âŠ‘ (step-âŠ‘ x) âŠ‘â‚) pcâ‹¤A) (join-â‹¤â‚ (trans-â‹¤ (step-âŠ‘ x) pcâ‹¤A))
      Î¼â‚‚â‰ˆÎ¼â‚ƒ = writeá´´-â‰ˆá´´ {{ validá´´ isVá´¾â€²â€² }} âˆˆâ‚ w vâ‰ˆ
  in trans-â‰ˆá´¾-Î¹ Î¼âŠ†Î¼â‚ (trans-â‰ˆá´¾-Î¹ Î¼â‚âŠ†Î¼â‚‚ âŸ¨ refl-â‰ˆË¢ {{ validË¢ isVá´¾â€²â€² }} , Î¼â‚‚â‰ˆÎ¼â‚ƒ âŸ© )
  where open Validá´¾

step-â‰ˆá´´ (Id x) pcâ‹¤A = step-â‰ˆá´´ x pcâ‹¤A

step-â‰ˆá´´ (UnId x eq) pcâ‹¤A = step-â‰ˆá´´ x pcâ‹¤A

--------------------------------------------------------------------------------

-- open _â‰ˆâŸ¨_,_âŸ©á´¬_
-- open import Data.Unit hiding (_â‰Ÿ_) -- ?
-- -- open import Generic.Heap ğ‘¯
-- -- open SecurityLattice ğ‘³
-- -- open import Generic.LValue
-- -- open HasLabel ğ‘¯ -- import Generic.LValue as H

-- wken-âˆƒ : âˆ€ {Ï„ Î² Î²'} {câ‚ câ‚‚ : FConf Ï„} â†’
--          Î² âŠ† Î²' â†’ (x : âˆƒ (Î» Î²'' â†’ Î²' âŠ† Î²'' Ã— câ‚ â‰ˆâŸ¨ Î²'' âŸ©á¶œ câ‚‚)) â†’
--          âˆƒ (Î» Î²'' â†’ Î² âŠ† Î²'' Ã— câ‚ â‰ˆâŸ¨ Î²'' âŸ©á¶œ câ‚‚)
-- wken-âˆƒ Î²âŠ†Î²' (Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ â‰ˆâ‚)  = Î²'' âˆ§ (trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'') âˆ§ â‰ˆâ‚

-- mutual

--   -- TINI for low steps
--   tiniá´¸ : âˆ€ {pc Î² Ï„ Î“ Î¼â‚ Î¼â‚‚ Î£â‚ Î£â‚‚ e} {Î¸â‚ Î¸â‚‚ : Env Î“} {câ‚' câ‚‚' : FConf Ï„} â†’
--                     let câ‚ = âŸ¨ Î£â‚ , Î¼â‚ ,  e âŸ©
--                         câ‚‚ = âŸ¨ Î£â‚‚ , Î¼â‚‚ ,  e âŸ© in
--                     câ‚ â‡“âŸ¨ Î¸â‚ , pc âŸ© câ‚' â†’
--                     câ‚‚ â‡“âŸ¨ Î¸â‚‚ , pc âŸ© câ‚‚' â†’
--                     âŸ¨ Î£â‚ , Î¼â‚ âŸ© â‰ˆâŸ¨ Î² âŸ©á´¾ âŸ¨ Î£â‚‚ , Î¼â‚‚ âŸ© â†’
--                     Î¸â‚ â‰ˆâŸ¨ Î² âŸ©á´± Î¸â‚‚ â†’
--                     pc âŠ‘ A â†’
--                     âˆƒ (Î» Î²' â†’ Î² âŠ† Î²' Ã— câ‚' â‰ˆâŸ¨ Î²' âŸ©á¶œ câ‚‚')
--   tiniá´¸ (Var Ï„âˆˆÎ“ refl) (Var .Ï„âˆˆÎ“ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ â‰ˆá´¾ , â‰ˆâ±½-âŠ‘ _ vâ‚â‰ˆvâ‚‚ âŸ©
--     where vâ‚â‰ˆvâ‚‚ = lookup-â‰ˆâ±½ Ï„âˆˆÎ“ Î¸â‚â‰ˆÎ¸â‚‚

--   tiniá´¸ Unit Unit â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ â‰ˆá´¾ , Valueá´¸ pcâŠ‘A Unit âŸ©

--   tiniá´¸ (Lbl â„“) (Lbl .â„“) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ â‰ˆá´¾ , Valueá´¸ pcâŠ‘A (Lbl â„“) âŸ©

--   -- Both true
--   tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨  Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ _ (Lbl â„“â‚) âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î¼â‚'â‰ˆÎ¼â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A

--   tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
--       = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´¸ (join-âŠ‘' pâ‚ pâ‚‚) (Trueá´¸ pcâŠ‘A) âŸ©

--   tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ p (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
--       = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚‚) âŸ©

--   tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î¼â‚'â‰ˆÎ¼â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
--   ... |  Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , vâ‰ˆ âŸ©
--     = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚' ) (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚‚' ) âŸ©

--     -- True vs False
--   tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | _ âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ _ (Lbl â„“â‚) âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î¼â‚'â‰ˆÎ¼â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A

--   tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | _ âˆ§ _ âˆ§  âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | _ âˆ§ _ âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
--       = âŠ¥-elim (â„“â‚â‹¤â„“â‚‚ â„“â‚âŠ‘â„“â‚‚)

--   tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ p (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
--       = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚‚) âŸ©

--   tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î¼â‚'â‰ˆÎ¼â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
--   ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚' ) (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚‚' ) âŸ©

--   -- False vs True
--   tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | _ âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ _ (Lbl â„“â‚) âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î¼â‚'â‰ˆÎ¼â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A

--   tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | _ âˆ§ _ âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | _ âˆ§ _ âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
--       = âŠ¥-elim (â„“â‚â‹¤â„“â‚‚ â„“â‚âŠ‘â„“â‚‚)

--   tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ p (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
--     = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚‚) âŸ©

--   tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î¼â‚'â‰ˆÎ¼â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
--   ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚' ) (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚‚' ) âŸ©


--   -- False and False
--   tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ _ (Lbl â„“â‚) âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î¼â‚'â‰ˆÎ¼â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A

--   tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
--       = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´¸ (join-âŠ‘' pâ‚ pâ‚‚) (Falseá´¸ pcâŠ‘A) âŸ©

--   tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ p (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
--       = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚‚) âŸ©

--   tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î¼â‚'â‰ˆÎ¼â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
--   ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , vâ‰ˆ âŸ©
--     = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚ƒâ‰ˆÎ¼â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚' ) (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚‚' ) âŸ©

--   tiniá´¸ Fun Fun â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ â‰ˆá´¾ , Valueá´¸ pcâŠ‘A (Fun Î¸â‚â‰ˆÎ¸â‚‚) âŸ©

--   tiniá´¸ (App x xâ‚ eqâ‚ xâ‚ƒ) (App xâ‚„ xâ‚… eqâ‚‚ xâ‚‡) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚„ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , vâ‚â‰ˆvâ‚‚ âŸ© with tiniá´¸ xâ‚ xâ‚… Î¼â‚'â‰ˆÎ¼â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
--   tiniá´¸ (App x xâ‚ eqâ‚ xâ‚ƒ) (App xâ‚„ xâ‚… eqâ‚‚ xâ‚‡) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ pcâŠ‘â„“' (Fun Î¸â‚'â‰ˆÎ¸â‚‚') âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚''â‰ˆÎ¼â‚‚'' , vâ‚'â‰ˆvâ‚‚' âŸ©
--       rewrite eqâ‚ | eqâ‚‚ = wken-âˆƒ (trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'') (tini {{ {!!} }} {{ {!!} }} xâ‚ƒ xâ‚‡  âŸ¨ Î¼â‚''â‰ˆÎ¼â‚‚'' , refl âŸ© (vâ‚'â‰ˆvâ‚‚' âˆ· wken-â‰ˆá´± Î²'âŠ†Î²'' Î¸â‚'â‰ˆÎ¸â‚‚' ))

--   tiniá´¸ (App x xâ‚ eqâ‚ xâ‚ƒ) (App xâ‚„ xâ‚… eqâ‚‚ xâ‚‡) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´´ pcâ‹¤â„“â‚ pcâ‹¤â„“â‚‚ âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚''â‰ˆÎ¼â‚‚'' , vâ‚'â‰ˆvâ‚‚' âŸ©
--       rewrite eqâ‚ | eqâ‚‚ =  wken-âˆƒ (trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'') (tiniá´´ {{ {!!} }} {{ {!!} }} Î¼â‚''â‰ˆÎ¼â‚‚'' xâ‚ƒ xâ‚‡ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) pcâ‹¤â„“â‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) pcâ‹¤â„“â‚‚))

--   tiniá´¸ (Wken p x) (Wken .p xâ‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = tiniá´¸ x xâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚â€² pcâŠ‘A
--     where Î¸â‚â‰ˆÎ¸â‚‚â€² = slice-â‰ˆá´± Î¸â‚â‰ˆÎ¸â‚‚ p

--   tiniá´¸ (Inl x) (Inl xâ‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , vâ‚â‰ˆvâ‚‚ âŸ© =  Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ pcâŠ‘A (Inl vâ‚â‰ˆvâ‚‚) âŸ©

--   tiniá´¸ (Inr x) (Inr xâ‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , vâ‚â‰ˆvâ‚‚ âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ pcâŠ‘A (Inr vâ‚â‰ˆvâ‚‚) âŸ©

--   tiniá´¸ (Caseâ‚ x refl xâ‚‚) (Caseâ‚ xâ‚ƒ refl xâ‚…) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ƒ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ â„“âŠ‘A (Inl vâ‚â‰ˆvâ‚‚) âŸ© = wken-âˆƒ Î²âŠ†Î²' (tini {{ {!!} }} {{ {!!} }} xâ‚‚ xâ‚… âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , refl âŸ© (vâ‚â‰ˆvâ‚‚ âˆ· wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚))
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ {!!} }} {{ {!!} }} Î¼â‚'â‰ˆÎ¼â‚‚' xâ‚‚ xâ‚… (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A))

--   tiniá´¸ (Caseâ‚ x refl xâ‚‚) (Caseâ‚‚ xâ‚ƒ refl xâ‚…) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ƒ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ â„“âŠ‘A () âŸ©
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ {!!} }} {{ {!!} }} Î¼â‚'â‰ˆÎ¼â‚‚' xâ‚‚ xâ‚… (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A))

--   tiniá´¸ (Caseâ‚‚ x refl xâ‚‚) (Caseâ‚ xâ‚ƒ refl xâ‚…) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ƒ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ â„“âŠ‘A () âŸ©
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ {!!} }} {{ {!!} }} Î¼â‚'â‰ˆÎ¼â‚‚' xâ‚‚ xâ‚… (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A))

--   tiniá´¸ (Caseâ‚‚ x refl xâ‚‚) (Caseâ‚‚ xâ‚ƒ refl xâ‚…) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ƒ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ â„“âŠ‘A (Inr vâ‚â‰ˆvâ‚‚) âŸ© = wken-âˆƒ Î²âŠ†Î²' (tini {{ {!!} }} {{ {!!} }} xâ‚‚ xâ‚… âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , refl âŸ© (vâ‚â‰ˆvâ‚‚ âˆ· wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚))
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ {!!} }} {{ {!!} }} Î¼â‚'â‰ˆÎ¼â‚‚' xâ‚‚ xâ‚… (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A))

--   tiniá´¸ (Pair x xâ‚) (Pair xâ‚‚ xâ‚ƒ) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , vâ‚â‰ˆvâ‚' âŸ© with tiniá´¸ xâ‚ xâ‚ƒ Î¼â‚'â‰ˆÎ¼â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
--   ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚''â‰ˆÎ¼â‚‚'' , vâ‚‚â‰ˆvâ‚‚' âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î¼â‚''â‰ˆÎ¼â‚‚'' , Valueá´¸ pcâŠ‘A (Pair (wken-â‰ˆâ±½ Î²'âŠ†Î²'' vâ‚â‰ˆvâ‚') vâ‚‚â‰ˆvâ‚‚') âŸ©

--   tiniá´¸ (Fst x refl) (Fst xâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ â„“âŠ‘A (Pair vâ‚â‰ˆvâ‚' vâ‚‚â‰ˆvâ‚‚') âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , â‰ˆâ±½-âŠ‘ _ vâ‚â‰ˆvâ‚' âŸ©
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

--   tiniá´¸ (Snd x refl) (Snd xâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ â„“âŠ‘A (Pair vâ‚â‰ˆvâ‚' vâ‚‚â‰ˆvâ‚‚') âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , â‰ˆâ±½-âŠ‘ _ vâ‚‚â‰ˆvâ‚‚' âŸ©
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

--   tiniá´¸ (LabelOf x) (LabelOf xâ‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ â„“âŠ‘A vâ‚â‰ˆvâ‚‚ âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ â„“âŠ‘A (Lbl _) âŸ©
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ©

--   tiniá´¸ GetLabel GetLabel â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ â‰ˆá´¾ , Valueá´¸ pcâŠ‘A (Lbl _) âŸ©

--   tiniá´¸ (Taint refl xâ‚ xâ‚‚ pc'âŠ‘pc'') (Taint refl xâ‚ƒ xâ‚„ pc'âŠ‘pc''') â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚ƒ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , Valueá´¸ â„“âŠ‘A (Lbl â„“) âŸ© = wken-âˆƒ Î²âŠ†Î²' ( tini {{ {!!} }} {{ {!!} }} xâ‚‚ xâ‚„ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , refl âŸ© (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚))
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© =  wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ {!!} }} {{ {!!} }} Î¼â‚'â‰ˆÎ¼â‚‚' xâ‚‚ xâ‚„ (trans-â‹¤ pc'âŠ‘pc'' â„“â‚â‹¤A) (trans-â‹¤ pc'âŠ‘pc''' â„“â‚‚â‹¤A))

--   tiniá´¸ (LabelOfRef xâ‚ refl) (LabelOfRef xâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Ref-Iá´¸ â„“âŠ‘Aâ‚) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , (Valueá´¸ (join-âŠ‘' â„“âŠ‘Aâ‚ â„“âŠ‘A) (Lbl _)) âŸ©
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Ref-Iá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , (Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚â‹¤A) (trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚‚â‹¤A)) âŸ©
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) â„“â‚â‹¤A) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) â„“â‚‚â‹¤A) âŸ©

--   tiniá´¸ (New {Î¼' = Î¼â‚} xâ‚) (New {Î¼' = Î¼â‚‚} xâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , Valueá´´ â‹¤â‚ â‹¤â‚‚  âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆâ€² , Î¼â‰ˆ âŸ© , vâ‰ˆâ€² âŸ©
--     where Î£â‰ˆâ€² = square-â‰ˆË¢-Î¹ {nâ‚ = âˆ¥ Î¼â‚ âˆ¥á´´} {nâ‚‚ = âˆ¥ Î¼â‚‚ âˆ¥á´´}  Î£â‰ˆ (updateá´´-â‰ˆË¢ _ _ {{ {!!} }} â‹¤â‚) (updateá´´-â‰ˆË¢ _ _ {{ {!!} }} â‹¤â‚‚)
--           vâ‰ˆâ€² = Valueá´¸ pcâŠ‘A (Ref-Iá´´ â‹¤â‚ â‹¤â‚‚)

--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , Valueá´¸ â„“âŠ‘A râ‰ˆ âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆâ€² , Î¼â‰ˆ âŸ© , vâ‰ˆâ€² âŸ©
--       where Mâ‰ˆ = getá´¸ Î£â‰ˆ â„“âŠ‘A
--             Î£â‰ˆâ€² = updateá´¸-â‰ˆË¢ Î£â‰ˆ (new-â‰ˆá´¹ Mâ‰ˆ  râ‰ˆ)
--             vâ‰ˆâ€² = Valueá´¸ pcâŠ‘A (Ref-Iá´¸â€² â„“âŠ‘A âˆ¥ Mâ‰ˆ âˆ¥-â‰¡ )

--   tiniá´¸ (Read xâ‚ nâˆˆMâ‚ refl) (Read xâ‚‚ nâˆˆMâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , Valueá´¸ â„“âŠ‘A (Ref-Iá´¸ â„“'âŠ‘A) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆ âŸ©
--        where Mâ‰ˆ = getá´¸ Î£â‰ˆ â„“'âŠ‘A
--              vâ‰ˆ = Valueá´¸ (join-âŠ‘' â„“'âŠ‘A â„“âŠ‘A) (read-â‰ˆá´¹ Mâ‰ˆ nâˆˆMâ‚ nâˆˆMâ‚‚)

--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Ref-Iá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , vâ‰ˆ âŸ©
--     where vâ‰ˆ = Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A)

--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , vâ‰ˆ âŸ©
--     where vâ‰ˆ = Valueá´´ (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A)

--   tiniá´¸ (Write {Î¼â‚ƒ = Î¼â‚ƒ} xâ‚ âŠ‘â‚ yâ‚ â„“â‚‚âŠ‘â„“ wâ‚) (Write {Î¼â‚ƒ = Î¼â‚ƒâ€²} xâ‚‚ âŠ‘â‚‚ yâ‚‚ â„“â‚‚âŠ‘â„“' wâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A

--   -- Write low-data in a secret-dependent reference
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© with tiniá´¸ yâ‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
--   ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ©  , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆâ€² , Î¼â‰ˆ âŸ© , Valueá´¸ pcâŠ‘A Unit âŸ©
--     where Î£â‚â‰ˆ = updateá´´-â‰ˆË¢ {n = âˆ¥ Î¼â‚ƒ âˆ¥á´´}  _ _ {{ {!!} }} (trans-â‹¤ âŠ‘â‚ â„“â‚â‹¤A)
--           Î£â‚‚â‰ˆ = updateá´´-â‰ˆË¢ {n = âˆ¥ Î¼â‚ƒâ€² âˆ¥á´´} _ _ {{ {!!} }} (trans-â‹¤ âŠ‘â‚‚ â„“â‚‚â‹¤A)
--           Î£â‰ˆâ€² = square-â‰ˆË¢-Î¹ Î£â‰ˆ Î£â‚â‰ˆ Î£â‚‚â‰ˆ

--   -- Write low data to low reference
--   tiniá´¸ (Write xâ‚ â„“'âŠ‘â„“ yâ‚ â„“â‚‚âŠ‘â„“ wâ‚) (Write xâ‚‚ â„“'âŠ‘â„“' yâ‚‚ â„“â‚‚âŠ‘â„“' wâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²'  âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Ref-Iá´¸ âŠ‘â‚) âŸ© with tiniá´¸ yâ‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
--   ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆâ€² , Î¼â‰ˆ âŸ© , Valueá´¸ pcâŠ‘A Unit âŸ©
--       where Mâ‰ˆ = getá´¸ Î£â‰ˆ âŠ‘â‚
--             Î£â‰ˆâ€² = updateá´¸-â‰ˆË¢ Î£â‰ˆ (update-â‰ˆá´¹ Mâ‰ˆ (extract-â‰ˆá´¿ vâ‰ˆ (trans-âŠ‘ â„“â‚‚âŠ‘â„“ âŠ‘â‚)) wâ‚ wâ‚‚)
--   -- Write low data to high reference
--   tiniá´¸ (Write {Î¼â‚ƒ = Î¼â‚ƒ} xâ‚ âŠ‘â‚ yâ‚ âŠ‘â‚â€² wâ‚) (Write {Î¼â‚ƒ = Î¼â‚ƒâ€²} xâ‚‚ âŠ‘â‚‚ yâ‚‚ âŠ‘â‚‚â€² wâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--     | Î²' âˆ§ Î²âŠ†Î²'  âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Ref-Iá´´ â‹¤â‚ â‹¤â‚‚) âŸ© with tiniá´¸ yâ‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
--   ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆâ€² , Î¼â‰ˆ âŸ© , Valueá´¸ pcâŠ‘A Unit âŸ©
--     where Î£â‚â‰ˆ = updateá´´-â‰ˆË¢ {n = âˆ¥ Î¼â‚ƒ âˆ¥á´´}  _ _ {{ {!!} }} â‹¤â‚
--           Î£â‚‚â‰ˆ = updateá´´-â‰ˆË¢ {n = âˆ¥ Î¼â‚ƒâ€² âˆ¥á´´} _ _ {{ {!!} }} â‹¤â‚‚
--           Î£â‰ˆâ€² = square-â‰ˆË¢-Î¹ Î£â‰ˆ Î£â‚â‰ˆ Î£â‚‚â‰ˆ

--   tiniá´¸ (Id xâ‚) (Id xâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with  tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , vâ‰ˆ âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ pcâŠ‘A (Id vâ‰ˆ) âŸ©

--   tiniá´¸ (UnId xâ‚ refl) (UnId xâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Id vâ‰ˆ) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , â‰ˆâ±½-âŠ‘ _ vâ‰ˆ âŸ©
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

--   tiniá´¸ (LabelOfRef-FS xâ‚ âˆˆâ‚ refl) (LabelOfRef-FS xâ‚‚ âˆˆâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , Valueá´¸ â„“âŠ‘A (Ref-S âˆˆÎ²') âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆ âŸ©
--     where vâ‰ˆ = â‰ˆâ±½-âŠ‘ _ (label-of-â‰ˆâ±½ (readá´¸-â‰ˆâ±½ âˆˆÎ²' âˆˆâ‚ âˆˆâ‚‚ Î¼â‰ˆ))
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

--   tiniá´¸ (New-FS {Î¼' = Î¼â‚'} xâ‚) (New-FS {Î¼' = Î¼â‚‚'} xâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆ  âŸ© = Î²'' âˆ§ Î²âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ wken-â‰ˆË¢ Î²'âŠ†Î²'' Î£â‰ˆ , Î¼â‰ˆâ€² âŸ© , wken-â‰ˆâ±½ (âˆ£á´®-âŠ†â‚‚ Î²' Î²â‚) vâ‰ˆâ€² âŸ©
--       where instance _ = _â‰Ÿ_
--                      _ = â‰ˆ-# Î¼â‰ˆ
--             Î²â‚ =  âˆ¥ Î¼â‚' âˆ¥á´´ â†” âˆ¥ Î¼â‚‚' âˆ¥á´´
--             Î²'' = Î²' âˆ£á´® Î²â‚
--             Î²'âŠ†Î²'' = âˆ£á´®-âŠ†â‚ Î²' Î²â‚
--             Î²âŠ†Î²'' = trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²''  -- Names?
--             Î¼â‰ˆâ€² = newá´¸-â‰ˆá´´ vâ‰ˆ Î¼â‰ˆ
--             vâ‰ˆâ€² = Valueá´¸ pcâŠ‘A (Ref-S (â†”-âˆˆáµ— âˆ¥ Î¼â‚' âˆ¥á´´ âˆ¥ Î¼â‚‚' âˆ¥á´´))


--   tiniá´¸ (Read-FS xâ‚ âˆˆâ‚ refl) (Read-FS xâ‚‚ âˆˆâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , vâ‰ˆ âŸ©
--     where vâ‰ˆ = Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚â‹¤A ) ((trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚‚â‹¤A ))

--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨  âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , Valueá´¸ â„“âŠ‘A (Ref-S âˆˆÎ²) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , â‰ˆâ±½-âŠ‘ _ vâ‰ˆ âŸ©
--        where vâ‰ˆ = readá´¸-â‰ˆâ±½ âˆˆÎ² âˆˆâ‚ âˆˆâ‚‚ Î¼â‰ˆ


--   tiniá´¸ (Write-FS {â„“ = â„“} {â„“â‚} {â„“â‚‚} {â„“â‚‚'} xâ‚ yâ‚ âˆˆâ‚ âŠ‘â‚ refl wâ‚) (Write-FS xâ‚‚ yâ‚‚ âˆˆâ‚‚ âŠ‘â‚‚ refl wâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , (Valueá´¸ â„“âŠ‘A (Ref-S âˆˆÎ²')) âŸ© with tiniá´¸ yâ‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
--   ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆâ€² âŸ© =
--             let âˆˆÎ²'' = bij-âŠ† Î²'âŠ†Î²'' âˆˆÎ²'
--                 vâ‰ˆ = readá´¸-â‰ˆâ±½ âˆˆÎ²'' âˆˆâ‚ âˆˆâ‚‚ Î¼â‰ˆ
--                 Î¼â‰ˆâ€² = writeá´¸-â‰ˆá´´ Î¼â‰ˆ (â‰ˆâ±½-âŠ‘ _ vâ‰ˆâ€²) wâ‚ wâ‚‚ âˆˆÎ²'' in
--                 Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆâ€² âŸ© , Valueá´¸ pcâŠ‘A Unit âŸ©

--   tiniá´¸ (Write-FS {â„“ = â„“} {â„“â‚} {â„“â‚‚} {â„“â‚‚'} xâ‚ yâ‚ âˆˆâ‚ âŠ‘â‚ refl wâ‚) (Write-FS xâ‚‚ yâ‚‚ âˆˆâ‚‚ âŠ‘â‚‚ refl wâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© with tiniá´¸ yâ‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
--   ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆâ€² âŸ© , Valueá´¸ pcâŠ‘A Unit âŸ©
--     where vâ‰ˆâ‚ = Valueá´´ (trans-â‹¤ âŠ‘â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚â‹¤A)
--           vâ‰ˆâ‚‚ = Valueá´´ (trans-â‹¤ âŠ‘â‚‚ â„“â‚‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A)
--           Î¼â‰ˆâ‚ = (writeá´´-â‰ˆá´´ {{ {!!} }} âˆˆâ‚ wâ‚ vâ‰ˆâ‚)
--           Î¼â‰ˆâ‚‚ = writeá´´-â‰ˆá´´ {{ {!!} }} âˆˆâ‚‚ wâ‚‚ vâ‰ˆâ‚‚
--           Î¼â‰ˆâ€² = square-â‰ˆá´´-Î¹ Î¼â‰ˆ  Î¼â‰ˆâ‚ Î¼â‰ˆâ‚‚


--   -- TINI for high steps. The computations depend on a secret and thus
--   -- might produce different results and code. We then prove TINI by
--   -- showing that the program counter can only remain secret and that
--   -- each high step preserves low-equivalence of stores.  In
--   -- particular we prove that the final stores are low-equivalent (Î¼â‚'
--   -- â‰ˆ Î¼â‚‚'), i.e., the square:
--   --
--   -- Î¼â‚ â‰ˆá´´ Î¼â‚'
--   -- â‰ˆá´´    â‰ˆá´´
--   -- Î¼â‚‚ â‰ˆá´´ Î¼â‚‚'
--   --
--   -- using transitivity and symmetry of â‰ˆá´´
--   -- TODO: do the same for FS-Store
--   tiniá´´ : âˆ€ {Ï„ Î“â‚ Î“â‚‚ Î¸â‚ Î¸â‚‚ pcâ‚ pcâ‚‚ Î²} {câ‚ : IConf Î“â‚ Ï„} {câ‚‚ : IConf Î“â‚‚ Ï„} {câ‚' câ‚‚' : FConf Ï„} â†’
--              let âŸ¨ Î£â‚ , Î¼â‚ , _ âŸ© = câ‚
--                  âŸ¨ Î£â‚‚ , Î¼â‚‚ , _ âŸ© = câ‚‚ in
--              -- {{validâ‚á´µ : Validá´µ câ‚}} {{validá´± : Validá´± âˆ¥ Î¼â‚ âˆ¥ Î¸â‚}} â†’
--              -- {{validâ‚‚á´µ : Validá´µ câ‚‚}} {{validâ‚‚á´± : Validá´± âˆ¥ Î¼â‚‚ âˆ¥ Î¸â‚‚}} â†’
--              {{validâ‚ : Valid-Inputs câ‚ Î¸â‚}} {{validâ‚‚ : Valid-Inputs câ‚‚ Î¸â‚‚}} â†’
--              âŸ¨ Î£â‚ , Î¼â‚ âŸ© â‰ˆâŸ¨ Î² âŸ©á´¾ âŸ¨ Î£â‚‚ , Î¼â‚‚ âŸ© â†’
--              câ‚ â‡“âŸ¨ Î¸â‚ , pcâ‚ âŸ© câ‚' â†’
--              câ‚‚ â‡“âŸ¨ Î¸â‚‚ , pcâ‚‚ âŸ© câ‚‚' â†’
--              pcâ‚ â‹¤ A â†’ pcâ‚‚ â‹¤ A â†’
--              âˆƒ (Î» Î²' â†’ Î² âŠ† Î²' Ã— câ‚' â‰ˆâŸ¨ Î²' âŸ©á¶œ câ‚‚')
--   -- Question: Do we actually need to prove Î² âŠ† Î²' ? Not clear from Banjaree proof if this is ever used.
--   -- The only reason I can think of is that the theorem might be trivial if we choose Î²' = âˆ…
--   -- because we do not need to take care of the references. Check this with Deepak.
--   -- Answer: We need that to weaken the bijection in L-equiv relations
--   tiniá´´ {Î² = Î²} {{âŸ¨ isVâ‚á´¾ , isVâ‚á´± âŸ© }} {{âŸ¨ isVâ‚‚á´¾  , isVâ‚‚á´± âŸ© }}
--          Î¼â‚â‰ˆÎ¼â‚‚ xâ‚ xâ‚‚ pcâ‚â‹¤A pcâ‚‚â‹¤A =
--     let Î¼â‚â‰ˆÎ¼â‚' = step-â‰ˆá´´ {{ isVâ‚á´¾ }} {{ isVâ‚á´± }} xâ‚ pcâ‚â‹¤A
--         Î¼â‚‚â‰ˆÎ¼â‚‚' = step-â‰ˆá´´ {{ isVâ‚‚á´¾ }} {{ isVâ‚‚á´± }} xâ‚‚ pcâ‚‚â‹¤A
--         Î¼â‚'â‰ˆÎ¼â‚‚' = square-â‰ˆá´¾-Î¹ Î¼â‚â‰ˆÎ¼â‚‚ Î¼â‚â‰ˆÎ¼â‚' Î¼â‚‚â‰ˆÎ¼â‚‚'
--         vâ‰ˆ = Valueá´´ (trans-â‹¤ (step-âŠ‘ xâ‚) pcâ‚â‹¤A) (trans-â‹¤ (step-âŠ‘ xâ‚‚) pcâ‚‚â‹¤A) in
--         Î² âˆ§ B.refl-âŠ† âˆ§ âŸ¨ Î¼â‚'â‰ˆÎ¼â‚‚' , vâ‰ˆ âŸ©


--   -- TINI: top level theorem
--   tini : âˆ€ {Ï„ Î“ Î¸â‚ Î¸â‚‚ pc Î²} {câ‚ câ‚‚ : IConf Î“ Ï„} {câ‚' câ‚‚' : FConf Ï„} â†’
--              -- {{validâ‚á´µ : Validá´µ câ‚}} {{validá´± : Validá´± âˆ¥ store câ‚ âˆ¥ Î¸â‚}} â†’
--              -- {{validâ‚‚á´µ : Validá´µ câ‚‚}} {{validâ‚‚á´± : Validá´± âˆ¥ store câ‚‚ âˆ¥ Î¸â‚‚}} â†’
--              {{validâ‚ : Valid-Inputs câ‚ Î¸â‚}} {{validâ‚‚ : Valid-Inputs câ‚‚ Î¸â‚‚}} â†’
--              câ‚ â‡“âŸ¨ Î¸â‚ , pc âŸ© câ‚' â†’
--              câ‚‚ â‡“âŸ¨ Î¸â‚‚ , pc âŸ© câ‚‚' â†’
--              câ‚ â‰ˆâŸ¨ Î² âŸ©á´µ câ‚‚ â†’
--              Î¸â‚ â‰ˆâŸ¨ Î² âŸ©á´± Î¸â‚‚ â†’
--              âˆƒ (Î» Î²' â†’ Î² âŠ† Î²' Ã— câ‚' â‰ˆâŸ¨ Î²' âŸ©á¶œ câ‚‚')
--   tini {pc = pc} xâ‚ xâ‚‚ âŸ¨ Î¼â‚â‰ˆÎ¼â‚‚ , refl âŸ©  Î¸â‚â‰ˆÎ¸â‚‚ with pc âŠ‘? A
--   ... | yes pcâŠ‘A = tiniá´¸ xâ‚ xâ‚‚ Î¼â‚â‰ˆÎ¼â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
--   ... | no pcâ‹¤A = tiniá´´ Î¼â‚â‰ˆÎ¼â‚‚ xâ‚ xâ‚‚ pcâ‹¤A pcâ‹¤A
--
