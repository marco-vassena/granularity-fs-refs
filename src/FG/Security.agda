-- This module proves security of FG, i.e., termination-insensitive
-- non-interference (TINI).  The proof consists in showing that the
-- big-step semantics preserves L-equivalence.
--
-- This module is parametric in the security lattice ğ‘³ = (ğ“›, âŠ‘) and in
-- the attacker's security A âˆˆ ğ“›.

open import Lattice

module FG.Security {{ğ‘³ : Lattice}} (A : Label) where

open import FG.Types
open import FG.Syntax
open import FG.Semantics
open import FG.LowEq A as E public

open import Data.Empty
open import Relation.Binary.PropositionalEquality
open import Relation.Nullary

--------------------------------------------------------------------------------
-- Lemmas on L-equivalent environments.

-- Lookup in L-equivalent envs gives L-equivalent values
lookup-â‰ˆâ±½ : âˆ€ {Ï„ Î“ Î¸â‚ Î¸â‚‚} â†’ (Ï„âˆˆÎ“ : Ï„ âˆˆ Î“) â†’ Î¸â‚ â‰ˆá´± Î¸â‚‚ â†’ (Î¸â‚ !! Ï„âˆˆÎ“) â‰ˆâ±½ (Î¸â‚‚ !! Ï„âˆˆÎ“)
lookup-â‰ˆâ±½ here (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚) = vâ‚â‰ˆvâ‚‚
lookup-â‰ˆâ±½ (there Ï„âˆˆÎ“) (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚) = lookup-â‰ˆâ±½ Ï„âˆˆÎ“ Î¸â‚â‰ˆÎ¸â‚‚


-- Slicing L-equivalent envs gives gives L-equivalent envs.
slice-â‰ˆá´± : âˆ€ {Î“â‚ Î“â‚‚} {Î¸â‚ Î¸â‚‚ : Env Î“â‚‚} â†’
                 Î¸â‚ â‰ˆá´± Î¸â‚‚ â†’
                 (Î“â‚âŠ†Î“â‚‚ : Î“â‚ âŠ† Î“â‚‚) â†’
                 slice Î¸â‚ Î“â‚âŠ†Î“â‚‚ â‰ˆá´± slice Î¸â‚‚ Î“â‚âŠ†Î“â‚‚
slice-â‰ˆá´± [] base = []
slice-â‰ˆá´± (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚) (cons p) = vâ‚â‰ˆvâ‚‚ âˆ· slice-â‰ˆá´± Î¸â‚â‰ˆÎ¸â‚‚ p
slice-â‰ˆá´± (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚) (drop p) = slice-â‰ˆá´± Î¸â‚â‰ˆÎ¸â‚‚ p

--------------------------------------------------------------------------------

open import Data.Product renaming (_Ã—_ to _âˆ§_ ; _,_ to âŸ¨_,_âŸ©)
open import Generic.Bijection

-- TODO: Ideally combined with the lemma below
step-â‰ˆá´´ : âˆ€ {Ï„ Î“ Î¸ pc} {c : IConf Î“ Ï„} {c' : FConf Ï„} â†’
             let âŸ¨ Î£ , Î¼ , _ âŸ© = c
                 âŸ¨ Î£' , Î¼' , _ âŸ© = c' in
               c â‡“âŸ¨ Î¸ , pc âŸ© c' â†’
               pc â‹¤ A â†’
               Î¼ â‰ˆá´´ Î¼'
step-â‰ˆá´´ {c = c} (Var Ï„âˆˆÎ“ x) pcâ‹¤A = âŸ¨ Î¹ , refl-â‰ˆá´´ {Î¼ = Conf.heap c} âŸ©
step-â‰ˆá´´ Unit pcâ‹¤A = {!!}
step-â‰ˆá´´ (Lbl â„“) pcâ‹¤A = {!!}
step-â‰ˆá´´ (Testâ‚ x xâ‚ xâ‚‚ xâ‚ƒ) pcâ‹¤A = {!!}
step-â‰ˆá´´ (Testâ‚‚ x xâ‚ xâ‚‚ xâ‚ƒ) pcâ‹¤A = {!!}
step-â‰ˆá´´ Fun pcâ‹¤A = {!!}
step-â‰ˆá´´ (App x xâ‚ refl xâ‚ƒ) pcâ‹¤A =
  let âŸ¨ Î² , Î¼â‰ˆÎ¼â‚ âŸ© = step-â‰ˆá´´ x pcâ‹¤A
      âŸ¨ Î²â‚ , Î¼â‚â‰ˆÎ¼â‚‚ âŸ© = step-â‰ˆá´´ xâ‚ pcâ‹¤A
      âŸ¨ Î²â‚‚ , Î¼â‚‚â‰ˆÎ¼â‚ƒ âŸ© = step-â‰ˆá´´ xâ‚ƒ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤A) in
        âŸ¨ Î²â‚‚ âˆ˜á´® Î²â‚ âˆ˜á´® Î² , (trans-â‰ˆá´´ {Î²â‚ = Î²} {Î²â‚‚ âˆ˜á´® Î²â‚} Î¼â‰ˆÎ¼â‚ (trans-â‰ˆá´´ {Î²â‚ = Î²â‚} {Î²â‚‚ = Î²â‚‚} Î¼â‚â‰ˆÎ¼â‚‚ Î¼â‚‚â‰ˆÎ¼â‚ƒ)) âŸ©
step-â‰ˆá´´ (Wken p x) pcâ‹¤A = {!!}
step-â‰ˆá´´ (Inl x) pcâ‹¤A = {!!}
step-â‰ˆá´´ (Inr x) pcâ‹¤A = {!!}
step-â‰ˆá´´ (Caseâ‚ x xâ‚ xâ‚‚) pcâ‹¤A = {!!}
step-â‰ˆá´´ (Caseâ‚‚ x xâ‚ xâ‚‚) pcâ‹¤A = {!!}
step-â‰ˆá´´ (Pair x xâ‚) pcâ‹¤A = {!!}
step-â‰ˆá´´ (Fst x xâ‚) pcâ‹¤A = {!!}
step-â‰ˆá´´ (Snd x xâ‚) pcâ‹¤A = {!!}
step-â‰ˆá´´ (LabelOf x) pcâ‹¤A = {!!}
step-â‰ˆá´´ GetLabel pcâ‹¤A = {!!}
step-â‰ˆá´´ (Taint eq x xâ‚ pc'âŠ‘pc'') pcâ‹¤A = {!!}
step-â‰ˆá´´ (LabelOfRef x eq) pcâ‹¤A = {!!}
step-â‰ˆá´´ (New x) pcâ‹¤A = {!!}
step-â‰ˆá´´ (Read x xâ‚ eq) pcâ‹¤A = {!!}
step-â‰ˆá´´ (Write x xâ‚ xâ‚‚ â„“â‚‚âŠ‘â„“ xâ‚ƒ) pcâ‹¤A = {!!}
step-â‰ˆá´´ (LabelOfRef-FS x xâ‚ eq) pcâ‹¤A = {!!}
step-â‰ˆá´´ (New-FS x) pcâ‹¤A =
  let âŸ¨ Î² , Î¼â‰ˆÎ¼' âŸ© = step-â‰ˆá´´ x pcâ‹¤A in new-â‰ˆá´´ Î¼â‰ˆÎ¼' _ (trans-â‹¤ (step-âŠ‘ x) pcâ‹¤A)
step-â‰ˆá´´ (Read-FS x xâ‚ eq) pcâ‹¤A = {!!}
step-â‰ˆá´´ (Write-FS x xâ‚ xâ‚‚ xâ‚ƒ eq xâ‚„) pcâ‹¤A = {!!}
step-â‰ˆá´´ (Id x) pcâ‹¤A = {!!}
step-â‰ˆá´´ (UnId x eq) pcâ‹¤A = {!!}


-- TODO: add FS-Store to this lemma
-- High steps preserve low-equivalence of stores
step-â‰ˆË¢ : âˆ€ {Ï„ Î“ Î¸ pc} {c : IConf Î“ Ï„} {c' : FConf Ï„} â†’
             let âŸ¨ Î£ , Î¼ , _ âŸ© = c
                 âŸ¨ Î£' , Î¼' , _ âŸ© = c' in
               c â‡“âŸ¨ Î¸ , pc âŸ© c' â†’
               pc â‹¤ A â†’
                 (Î£ â‰ˆË¢ Î£')

step-â‰ˆË¢ (Var Ï„âˆˆÎ“ x) pcâ‹¤A = refl-â‰ˆË¢
step-â‰ˆË¢ Unit pcâ‹¤A = refl-â‰ˆË¢
step-â‰ˆË¢ (Lbl â„“) pcâ‹¤A = refl-â‰ˆË¢
step-â‰ˆË¢ (Testâ‚ x xâ‚ xâ‚‚ refl) pcâ‹¤A = trans-â‰ˆË¢ Î£â‚â‰ˆÎ£â‚‚â€² Î£â‚â‰ˆÎ£â‚‚â€²â€²
  where Î£â‚â‰ˆÎ£â‚‚â€² = step-â‰ˆË¢ x pcâ‹¤A
        Î£â‚â‰ˆÎ£â‚‚â€²â€² = step-â‰ˆË¢ xâ‚ pcâ‹¤A
step-â‰ˆË¢ (Testâ‚‚ x xâ‚ xâ‚‚ refl) pcâ‹¤A = trans-â‰ˆË¢ Î£â‚â‰ˆÎ£â‚‚â€² Î£â‚â‰ˆÎ£â‚‚â€²â€²
  where Î£â‚â‰ˆÎ£â‚‚â€² = step-â‰ˆË¢ x pcâ‹¤A
        Î£â‚â‰ˆÎ£â‚‚â€²â€² = step-â‰ˆË¢ xâ‚ pcâ‹¤A
step-â‰ˆË¢ Fun pcâ‹¤A = refl-â‰ˆË¢
step-â‰ˆË¢ (App x xâ‚ refl xâ‚ƒ) pcâ‹¤A = trans-â‰ˆË¢ Î£â‚â‰ˆÎ£â‚‚â€² (trans-â‰ˆË¢ Î£â‚â‰ˆÎ£â‚‚â€²â€² Î£â‚â‰ˆÎ£â‚‚â€²â€²â€²)
  where Î£â‚â‰ˆÎ£â‚‚â€² = step-â‰ˆË¢ x pcâ‹¤A
        Î£â‚â‰ˆÎ£â‚‚â€²â€² = step-â‰ˆË¢ xâ‚ pcâ‹¤A
        Î£â‚â‰ˆÎ£â‚‚â€²â€²â€² = step-â‰ˆË¢ xâ‚ƒ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤A)
step-â‰ˆË¢ (Wken p x) pcâ‹¤A = step-â‰ˆË¢ x pcâ‹¤A
step-â‰ˆË¢ (Inl x) pcâ‹¤A = step-â‰ˆË¢ x pcâ‹¤A
step-â‰ˆË¢ (Inr x) pcâ‹¤A = step-â‰ˆË¢ x pcâ‹¤A
step-â‰ˆË¢ (Caseâ‚ x refl xâ‚‚) pcâ‹¤A = trans-â‰ˆË¢ Î£â‰ˆÎ£' Î£'â‰ˆÎ£''
  where Î£â‰ˆÎ£' = step-â‰ˆË¢ x pcâ‹¤A
        Î£'â‰ˆÎ£'' = step-â‰ˆË¢ xâ‚‚ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤A)
step-â‰ˆË¢ (Caseâ‚‚ x refl xâ‚‚) pcâ‹¤A = trans-â‰ˆË¢ Î£â‰ˆÎ£' Î£'â‰ˆÎ£''
  where Î£â‰ˆÎ£' = step-â‰ˆË¢ x pcâ‹¤A
        Î£'â‰ˆÎ£'' = step-â‰ˆË¢ xâ‚‚ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤A)
step-â‰ˆË¢ (Pair x xâ‚) pcâ‹¤A = trans-â‰ˆË¢ Î£â‰ˆÎ£' Î£'â‰ˆÎ£''
  where Î£â‰ˆÎ£' = step-â‰ˆË¢ x pcâ‹¤A
        Î£'â‰ˆÎ£'' = step-â‰ˆË¢ xâ‚ pcâ‹¤A
step-â‰ˆË¢ (Fst x xâ‚) pcâ‹¤A = step-â‰ˆË¢ x pcâ‹¤A
step-â‰ˆË¢ (Snd x xâ‚) pcâ‹¤A = step-â‰ˆË¢ x pcâ‹¤A
step-â‰ˆË¢ (LabelOf x) pcâ‹¤A = step-â‰ˆË¢ x pcâ‹¤A
step-â‰ˆË¢ GetLabel pcâ‹¤A = refl-â‰ˆË¢
step-â‰ˆË¢ (Taint refl xâ‚ xâ‚‚ pc'âŠ‘pc'') pcâ‹¤A = trans-â‰ˆË¢ Î£â‰ˆÎ£' Î£'â‰ˆÎ£''
  where Î£â‰ˆÎ£' = step-â‰ˆË¢ xâ‚ pcâ‹¤A
        Î£'â‰ˆÎ£'' = step-â‰ˆË¢ xâ‚‚ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤A)
step-â‰ˆË¢ (LabelOfRef x eq) pcâ‹¤A = step-â‰ˆË¢ x pcâ‹¤A
step-â‰ˆË¢ (New x) pcâ‹¤A = trans-â‰ˆË¢ Î£â‰ˆÎ£' Î£'â‰ˆÎ£''
  where Î£â‰ˆÎ£' = step-â‰ˆË¢ x pcâ‹¤A
        Î£'â‰ˆÎ£'' = updateá´´-â‰ˆË¢ _ _ (trans-â‹¤ (step-âŠ‘ x) pcâ‹¤A)
step-â‰ˆË¢ (Read xâ‚ xâ‚‚ eq) pcâ‹¤A = step-â‰ˆË¢ xâ‚ pcâ‹¤A
step-â‰ˆË¢ (Write x â„“'âŠ‘pc xâ‚‚ â„“â‚‚âŠ‘â„“ xâ‚ƒ) pcâ‹¤A = trans-â‰ˆË¢ Î£â‰ˆÎ£' (trans-â‰ˆË¢ Î£'â‰ˆÎ£'' Î£''â‰ˆÎ£''')
  where pcâŠ‘â„“ = trans-âŠ‘ (step-âŠ‘ xâ‚‚) â„“â‚‚âŠ‘â„“
        Î£â‰ˆÎ£' = step-â‰ˆË¢ x pcâ‹¤A
        Î£'â‰ˆÎ£'' = step-â‰ˆË¢ xâ‚‚ pcâ‹¤A
        Î£''â‰ˆÎ£''' = updateá´´-â‰ˆË¢ _ _ (trans-â‹¤ pcâŠ‘â„“ pcâ‹¤A)
step-â‰ˆË¢ (Id x) pcâ‹¤A = step-â‰ˆË¢ x pcâ‹¤A
step-â‰ˆË¢ (UnId xâ‚ xâ‚‚) pcâ‹¤A = step-â‰ˆË¢ xâ‚ pcâ‹¤A

--------------------------------------------------------------------------------

open _â‰ˆâŸ¨_âŸ©á´¬_

mutual

  -- TINI for low steps
  postulate tiniá´¸ : âˆ€ {pc Ï„ Î“ Î£â‚ Î£â‚‚ Î¼â‚ Î¼â‚‚ e} {Î¸â‚ Î¸â‚‚ : Env Î“} {câ‚' câ‚‚' : FConf Ï„} â†’
                    let câ‚ = âŸ¨ Î£â‚ , Î¼â‚ , e âŸ©
                        câ‚‚ = âŸ¨ Î£â‚‚ , Î¼â‚‚ , e âŸ© in
                    câ‚ â‡“âŸ¨ Î¸â‚ , pc âŸ© câ‚' â†’
                    câ‚‚ â‡“âŸ¨ Î¸â‚‚ , pc âŸ© câ‚‚' â†’
                    Î£â‚ â‰ˆË¢ Î£â‚‚ â†’
                    Î¸â‚ â‰ˆá´± Î¸â‚‚ â†’
                    pc âŠ‘ A â†’
                    câ‚' â‰ˆá¶œ câ‚‚'

  -- tiniá´¸ (Var Ï„âˆˆÎ“ refl) (Var .Ï„âˆˆÎ“ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = âŸ¨ Î£â‚â‰ˆÎ£â‚‚ , â‰ˆâ±½-âŠ‘ _ vâ‚â‰ˆvâ‚‚ âŸ©
  --   where vâ‚â‰ˆvâ‚‚ = lookup-â‰ˆâ±½ Ï„âˆˆÎ“ Î¸â‚â‰ˆÎ¸â‚‚

  -- tiniá´¸ Unit Unit Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = âŸ¨ Î£â‚â‰ˆÎ£â‚‚ ,  Valueá´¸ pcâŠ‘A Unit âŸ©

  -- tiniá´¸ (Lbl â„“) (Lbl .â„“) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = âŸ¨ Î£â‚â‰ˆÎ£â‚‚ , Valueá´¸ pcâŠ‘A (Lbl â„“) âŸ©

  -- -- Both true
  -- tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ _ (Lbl â„“â‚) âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A

  -- tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
  --     = âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´¸ (join-âŠ‘' pâ‚ pâ‚‚) (Trueá´¸ pcâŠ‘A) âŸ©

  -- tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ p (Lbl â„“â‚) âŸ© | âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
  --     = âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚‚) âŸ©

  -- tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , vâ‰ˆ âŸ© = âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚' ) (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚‚' ) âŸ©


  -- -- True vs False
  -- tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ _ (Lbl â„“â‚) âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A

  -- tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
  --     = âŠ¥-elim (â„“â‚â‹¤â„“â‚‚ â„“â‚âŠ‘â„“â‚‚)

  -- tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ p (Lbl â„“â‚) âŸ© | âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
  --     = âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚‚) âŸ©

  -- tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , vâ‰ˆ âŸ© = âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚' ) (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚‚' ) âŸ©

  -- -- False vs True
  -- tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ _ (Lbl â„“â‚) âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A

  -- tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
  --     = âŠ¥-elim (â„“â‚â‹¤â„“â‚‚ â„“â‚âŠ‘â„“â‚‚)

  -- tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ p (Lbl â„“â‚) âŸ© | âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
  --     = âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚‚) âŸ©

  -- tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , vâ‰ˆ âŸ© = âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚' ) (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚‚' ) âŸ©


  -- -- False and False
  -- tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ _ (Lbl â„“â‚) âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A

  -- tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
  --     = âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´¸ (join-âŠ‘' pâ‚ pâ‚‚) (Falseá´¸ pcâŠ‘A) âŸ©

  -- tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ p (Lbl â„“â‚) âŸ© | âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
  --     = âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚‚) âŸ©

  -- tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , vâ‰ˆ âŸ© = âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚' ) (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚‚' ) âŸ©

  -- tiniá´¸ Fun Fun Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = âŸ¨ Î£â‚â‰ˆÎ£â‚‚ , Valueá´¸ pcâŠ‘A (Fun Î¸â‚â‰ˆÎ¸â‚‚) âŸ©

  -- tiniá´¸ (App x xâ‚ eqâ‚ xâ‚ƒ) (App xâ‚„ xâ‚… eqâ‚‚ xâ‚‡) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚„ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , vâ‚â‰ˆvâ‚‚ âŸ© with tiniá´¸ xâ‚ xâ‚… Î£â‚'â‰ˆÎ£â‚‚' Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- tiniá´¸ (App x xâ‚ eqâ‚ xâ‚ƒ) (App xâ‚„ xâ‚… eqâ‚‚ xâ‚‡) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , E.Valueá´¸ pcâŠ‘â„“' (Fun Î¸â‚'â‰ˆÎ¸â‚‚') âŸ© | âŸ¨ Î£â‚''â‰ˆÎ£â‚‚'' , vâ‚'â‰ˆvâ‚‚' âŸ©
  --     rewrite eqâ‚ | eqâ‚‚ = tini xâ‚ƒ xâ‚‡ âŸ¨ Î£â‚''â‰ˆÎ£â‚‚'' , refl âŸ© (vâ‚'â‰ˆvâ‚‚' âˆ· Î¸â‚'â‰ˆÎ¸â‚‚')
  -- tiniá´¸ (App x xâ‚ eqâ‚ xâ‚ƒ) (App xâ‚„ xâ‚… eqâ‚‚ xâ‚‡) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , E.Valueá´´ pcâ‹¤â„“â‚ pcâ‹¤â„“â‚‚ âŸ© | âŸ¨ Î£â‚''â‰ˆÎ£â‚‚'' , vâ‚'â‰ˆvâ‚‚' âŸ©
  --     rewrite eqâ‚ | eqâ‚‚ = tiniá´´ Î£â‚''â‰ˆÎ£â‚‚'' xâ‚ƒ xâ‚‡ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) pcâ‹¤â„“â‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) pcâ‹¤â„“â‚‚)

  -- tiniá´¸ (Wken p x) (Wken .p xâ‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = tiniá´¸ x xâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚â€² pcâŠ‘A
  --   where Î¸â‚â‰ˆÎ¸â‚‚â€² = slice-â‰ˆá´± Î¸â‚â‰ˆÎ¸â‚‚ p

  -- tiniá´¸ (Inl x) (Inl xâ‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , vâ‚â‰ˆvâ‚‚ âŸ© = âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ pcâŠ‘A (Inl vâ‚â‰ˆvâ‚‚) âŸ©

  -- tiniá´¸ (Inr x) (Inr xâ‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , vâ‚â‰ˆvâ‚‚ âŸ© = âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ pcâŠ‘A (Inr vâ‚â‰ˆvâ‚‚) âŸ©

  -- tiniá´¸ (Caseâ‚ x refl xâ‚‚) (Caseâ‚ xâ‚ƒ refl xâ‚…) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ƒ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A (Inl vâ‚â‰ˆvâ‚‚) âŸ© = tini xâ‚‚ xâ‚… âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , refl âŸ© (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚)
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = tiniá´´ Î£â‚'â‰ˆÎ£â‚‚' xâ‚‚ xâ‚… (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A)

  -- tiniá´¸ (Caseâ‚ x refl xâ‚‚) (Caseâ‚‚ xâ‚ƒ refl xâ‚…) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A  with tiniá´¸ x xâ‚ƒ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A () âŸ©
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = tiniá´´ Î£â‚'â‰ˆÎ£â‚‚' xâ‚‚ xâ‚… (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A)

  -- tiniá´¸ (Caseâ‚‚ x refl xâ‚‚) (Caseâ‚ xâ‚ƒ refl xâ‚…) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ƒ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A () âŸ©
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = tiniá´´ Î£â‚'â‰ˆÎ£â‚‚' xâ‚‚ xâ‚… (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A)

  -- tiniá´¸ (Caseâ‚‚ x refl xâ‚‚) (Caseâ‚‚ xâ‚ƒ refl xâ‚…) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ƒ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A (Inr vâ‚â‰ˆvâ‚‚) âŸ© = tini xâ‚‚ xâ‚… âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , refl âŸ© (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚)
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = tiniá´´ Î£â‚'â‰ˆÎ£â‚‚' xâ‚‚ xâ‚… (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A)

  -- tiniá´¸ (Pair x xâ‚) (Pair xâ‚‚ xâ‚ƒ) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , vâ‚â‰ˆvâ‚' âŸ© with tiniá´¸ xâ‚ xâ‚ƒ Î£â‚'â‰ˆÎ£â‚‚' Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚''â‰ˆÎ£â‚‚'' , vâ‚‚â‰ˆvâ‚‚' âŸ© = âŸ¨ Î£â‚''â‰ˆÎ£â‚‚'' , Valueá´¸ pcâŠ‘A (Pair vâ‚â‰ˆvâ‚' vâ‚‚â‰ˆvâ‚‚') âŸ©

  -- tiniá´¸ (Fst x refl) (Fst xâ‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A (Pair vâ‚â‰ˆvâ‚' vâ‚‚â‰ˆvâ‚‚') âŸ© = âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , â‰ˆâ±½-âŠ‘ _ vâ‚â‰ˆvâ‚' âŸ©
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

  -- tiniá´¸ (Snd x refl) (Snd xâ‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A (Pair vâ‚â‰ˆvâ‚' vâ‚‚â‰ˆvâ‚‚') âŸ© = âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , â‰ˆâ±½-âŠ‘ _ vâ‚‚â‰ˆvâ‚‚' âŸ©
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

  -- tiniá´¸ (LabelOf x) (LabelOf xâ‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A vâ‚â‰ˆvâ‚‚ âŸ© = âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A (Lbl _) âŸ©
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ©

  -- tiniá´¸ GetLabel GetLabel Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = âŸ¨ Î£â‚â‰ˆÎ£â‚‚ , Valueá´¸ pcâŠ‘A (Lbl _) âŸ©

  -- tiniá´¸ (Taint refl xâ‚ xâ‚‚ pc'âŠ‘pc'') (Taint refl xâ‚ƒ xâ‚„ pc'âŠ‘pc''') Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   with tiniá´¸ xâ‚ xâ‚ƒ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , E.Valueá´¸ â„“âŠ‘A (E.Lbl â„“) âŸ© = tini xâ‚‚ xâ‚„ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , refl âŸ© Î¸â‚â‰ˆÎ¸â‚‚
  -- ... | âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = tiniá´´ Î£â‚'â‰ˆÎ£â‚‚' xâ‚‚ xâ‚„ (trans-â‹¤ pc'âŠ‘pc'' â„“â‚â‹¤A) (trans-â‹¤ pc'âŠ‘pc''' â„“â‚‚â‹¤A)

  -- tiniá´¸ (LabelOfRef xâ‚ refl) (LabelOfRef xâ‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (E.Ref-Iá´¸ â„“âŠ‘Aâ‚ n) âŸ© = E.âŸ¨ Î£â‰ˆ , (Valueá´¸ (join-âŠ‘' â„“âŠ‘Aâ‚ â„“âŠ‘A) (Lbl _)) âŸ©
  -- ... | E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (E.Ref-Iá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = E.âŸ¨ Î£â‰ˆ , (Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚â‹¤A) (trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚‚â‹¤A)) âŸ©
  -- ... | E.âŸ¨ Î£â‰ˆ , E.Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = E.âŸ¨ Î£â‰ˆ , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) â„“â‚â‹¤A) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) â„“â‚‚â‹¤A) âŸ©

  -- tiniá´¸ (New x) (New xâ‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | E.âŸ¨ Î£â‰ˆ , E.Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = E.âŸ¨ Î£â‰ˆâ€² , râ‰ˆâ€² âŸ©
  --     where Î£â‰ˆâ€² = square-â‰ˆË¢ Î£â‰ˆ (updateá´´-â‰ˆË¢ _ _ â„“â‚â‹¤A) (updateá´´-â‰ˆË¢ _ _ â„“â‚‚â‹¤A)
  --           râ‰ˆâ€² = Valueá´¸ pcâŠ‘A (Ref-Iá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A)

  -- ... | E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A râ‰ˆ âŸ© = E.âŸ¨ Î£â‰ˆâ€² , râ‰ˆâ€² âŸ©
  --     where Mâ‰ˆ = getá´¸ Î£â‰ˆ â„“âŠ‘A
  --           Î£â‰ˆâ€² = updateá´¸-â‰ˆË¢ Î£â‰ˆ (new-â‰ˆá´¹ Mâ‰ˆ  râ‰ˆ)
  --           râ‰ˆâ€² = Valueá´¸ pcâŠ‘A (Ref-Iá´¸â€² â„“âŠ‘A âˆ¥ Mâ‰ˆ  âˆ¥-â‰¡)

  -- tiniá´¸ (Read xâ‚ nâˆˆMâ‚ refl) (Read xâ‚‚ nâˆˆMâ‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (Ref-Iá´¸ â„“'âŠ‘A n) âŸ© = E.âŸ¨ Î£â‰ˆ , vâ‰ˆ âŸ©
  --   where Mâ‰ˆ = getá´¸ Î£â‰ˆ â„“'âŠ‘A
  --         vâ‰ˆ = Valueá´¸ (join-âŠ‘' â„“'âŠ‘A â„“âŠ‘A) (read-â‰ˆá´¹ Mâ‰ˆ nâˆˆMâ‚ nâˆˆMâ‚‚)

  -- ... | E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (Ref-Iá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = E.âŸ¨ Î£â‰ˆ , vâ‰ˆ âŸ©
  --   where vâ‰ˆ = Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚â‹¤A) (trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚‚â‹¤A)

  -- ... | E.âŸ¨ Î£â‰ˆ , E.Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = E.âŸ¨ Î£â‰ˆ , vâ‰ˆ âŸ©
  --   where vâ‰ˆ = Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) â„“â‚â‹¤A) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) â„“â‚‚â‹¤A)

  -- tiniá´¸ (Write xâ‚ â„“'âŠ‘pc xâ‚ƒ â„“â‚‚âŠ‘â„“ Mâ‰”â‚) (Write xâ‚‚ â„“'âŠ‘pc' xâ‚„ â„“â‚‚âŠ‘â„“' Mâ‰”â‚‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A

  -- -- Write high reference in low context (impossible)
  -- ... | E.âŸ¨ Î£â‰ˆ , E.Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = âŠ¥-elim (â„“â‚‚â‹¤A (trans-âŠ‘ â„“'âŠ‘pc' pcâŠ‘A))

  -- ... | E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A râ‰ˆ' âŸ© with tiniá´¸ xâ‚ƒ xâ‚„ Î£â‰ˆ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A

  -- -- Write low data to low-reference
  -- tiniá´¸ (Write xâ‚ â„“'âŠ‘pc xâ‚ƒ â„“â‚‚âŠ‘â„“ Mâ‰”â‚) (Write xâ‚‚ â„“'âŠ‘pc' xâ‚„ â„“â‚‚âŠ‘â„“' Mâ‰”â‚‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (E.Ref-Iá´¸ â„“âŠ‘Aâ‚ n) âŸ© | E.âŸ¨ Î£â‰ˆâ€² , E.Valueá´¸ â„“âŠ‘Aâ‚‚ râ‰ˆ âŸ© = âŸ¨ Î£â‰ˆâ€²â€² , Valueá´¸ pcâŠ‘A Unit âŸ©
  --     where Mâ‰ˆ = getá´¸ Î£â‰ˆâ€² â„“âŠ‘Aâ‚
  --           Î£â‰ˆâ€²â€² = updateá´¸-â‰ˆË¢ Î£â‰ˆâ€² (update-â‰ˆá´¹ Mâ‰ˆ  râ‰ˆ Mâ‰”â‚ Mâ‰”â‚‚)

  -- -- Write high data to low-reference (impossible)
  -- tiniá´¸ (Write xâ‚ â„“'âŠ‘pc xâ‚ƒ â„“â‚‚âŠ‘â„“ Mâ‰”â‚) (Write xâ‚‚ â„“'âŠ‘pc' xâ‚„ â„“â‚‚âŠ‘â„“' Mâ‰”â‚‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (E.Ref-Iá´¸ â„“âŠ‘Aâ‚ n) âŸ© | E.âŸ¨ Î£â‰ˆâ€² , E.Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = âŠ¥-elim (â„“â‚‚â‹¤A (trans-âŠ‘ â„“â‚‚âŠ‘â„“' â„“âŠ‘Aâ‚))

  -- -- Write low data to high reference
  -- tiniá´¸ (Write xâ‚ â„“'âŠ‘pc xâ‚ƒ â„“â‚‚âŠ‘â„“ Mâ‰”â‚) (Write xâ‚‚ â„“'âŠ‘pc' xâ‚„ â„“â‚‚âŠ‘â„“' Mâ‰”â‚‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  --   | E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (E.Ref-Iá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© | E.âŸ¨ Î£â‰ˆâ€² , vâ‰ˆ âŸ© = âŸ¨ Î£â‰ˆâ€²â€² , Valueá´¸ pcâŠ‘A Unit âŸ©
  --     where Î£â‰ˆâ€²â€² = square-â‰ˆË¢ Î£â‰ˆâ€² (updateá´´-â‰ˆË¢ _ _ â„“â‚â‹¤A) (updateá´´-â‰ˆË¢ _ _ â„“â‚‚â‹¤A)

  -- tiniá´¸ (Id xâ‚) (Id xâ‚‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | E.âŸ¨ Î£â‰ˆ , vâ‰ˆ âŸ© = E.âŸ¨ Î£â‰ˆ , Valueá´¸ pcâŠ‘A (E.Id vâ‰ˆ) âŸ©

  -- tiniá´¸ (UnId xâ‚ refl) (UnId xâ‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (Id vâ‰ˆ) âŸ© = E.âŸ¨ Î£â‰ˆ , â‰ˆâ±½-âŠ‘ _ vâ‰ˆ âŸ©
  -- ... | E.âŸ¨ Î£â‰ˆ , E.Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = E.âŸ¨ Î£â‰ˆ , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©


  -- TINI for high steps. The computations depend on a secret and thus
  -- might produce different results and code. We then prove TINI by
  -- showing that the program counter can only remain secret and that
  -- each high step preserves low-equivalence of stores.  In
  -- particular we prove that the final stores are low-equivalent (Î£â‚'
  -- â‰ˆ Î£â‚‚'), i.e., the square:
  --
  -- Î£â‚ â‰ˆË¢ Î£â‚'
  -- â‰ˆË¢    â‰ˆË¢
  -- Î£â‚‚ â‰ˆË¢ Î£â‚‚'
  --
  -- using transitivity and symmetry of â‰ˆË¢
  -- TODO: do the same for FS-Store
  tiniá´´ : âˆ€ {Ï„ Î“â‚ Î“â‚‚ Î¸â‚ Î¸â‚‚ pcâ‚ pcâ‚‚} {câ‚ : IConf Î“â‚ Ï„} {câ‚‚ : IConf Î“â‚‚ Ï„} {câ‚' câ‚‚' : FConf Ï„} â†’
           let âŸ¨ Î£â‚ , _ , _ âŸ© = câ‚
               âŸ¨ Î£â‚‚ , _ , _ âŸ© = câ‚‚ in
           Î£â‚ â‰ˆË¢ Î£â‚‚ â†’
           câ‚ â‡“âŸ¨ Î¸â‚ , pcâ‚ âŸ© câ‚' â†’
           câ‚‚ â‡“âŸ¨ Î¸â‚‚ , pcâ‚‚ âŸ© câ‚‚' â†’
           pcâ‚ â‹¤ A â†’ pcâ‚‚ â‹¤ A â†’
           câ‚' â‰ˆá¶œ câ‚‚'
  tiniá´´ Î£â‚â‰ˆÎ£â‚‚ xâ‚ xâ‚‚ pcâ‚â‹¤A pcâ‚‚â‹¤A = {!!} -- âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , vâ‰ˆ âŸ©
    where Î£â‚â‰ˆÎ£â‚' = step-â‰ˆË¢ xâ‚ pcâ‚â‹¤A
          Î£â‚‚â‰ˆÎ£â‚‚' = step-â‰ˆË¢ xâ‚‚ pcâ‚‚â‹¤A
          Î£â‚'â‰ˆÎ£â‚‚' = square-â‰ˆË¢ Î£â‚â‰ˆÎ£â‚‚ Î£â‚â‰ˆÎ£â‚' Î£â‚‚â‰ˆÎ£â‚‚'
          vâ‰ˆ = Valueá´´ (trans-â‹¤ (step-âŠ‘ xâ‚) pcâ‚â‹¤A) (trans-â‹¤ (step-âŠ‘ xâ‚‚) pcâ‚‚â‹¤A)

  -- TINI: top level theorem
  tini : âˆ€ {Ï„ Î“ Î¸â‚ Î¸â‚‚ pc} {câ‚ câ‚‚ : IConf Î“ Ï„} {câ‚' câ‚‚' : FConf Ï„} â†’
           câ‚ â‡“âŸ¨ Î¸â‚ , pc âŸ© câ‚' â†’
           câ‚‚ â‡“âŸ¨ Î¸â‚‚ , pc âŸ© câ‚‚' â†’
           câ‚ â‰ˆá´µ câ‚‚ â†’
           Î¸â‚ â‰ˆá´± Î¸â‚‚ â†’
           câ‚' â‰ˆá¶œ câ‚‚'
  tini = {!!}
  -- {pc = pc} xâ‚ xâ‚‚ âŸ¨ Î£â‚â‰ˆÎ£â‚‚ , refl âŸ©  Î¸â‚â‰ˆÎ¸â‚‚ with pc âŠ‘? A
  -- ... | yes pcâŠ‘A = tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  -- ... | no pcâ‹¤A = tiniá´´ Î£â‚â‰ˆÎ£â‚‚ xâ‚ xâ‚‚ pcâ‹¤A pcâ‹¤A
