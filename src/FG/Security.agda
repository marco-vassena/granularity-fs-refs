-- This module proves security of FG, i.e., termination-insensitive
-- non-interference (TINI).  The proof consists in showing that the
-- big-step semantics preserves L-equivalence.
--
-- This module is parametric in the security lattice ğ‘³ = (ğ“›, âŠ‘) and in
-- the attacker's security level A âˆˆ ğ“›.

open import Lattice hiding (_â‰Ÿ_)

module FG.Security {{ğ‘³ : Lattice}} (A : Label) where

open import Data.Empty
open import Relation.Binary.PropositionalEquality
open import Relation.Nullary
open import Data.Product renaming (_,_ to _âˆ§_) hiding (,_)
open import Data.Nat hiding (_^_)

-- FG Definitions
open import FG.Types hiding (_Ã—_) renaming (_âŠ†_ to _âŠ†á¶œ_) hiding (refl-âŠ†)
open import FG.Syntax hiding (_âˆ˜_ )
open import FG.Semantics
open import Generic.Bijection as B hiding (_âˆˆ_)
open import FG.LowEq A public

-- Valid assumptions
open import FG.Valid
open import Generic.Valid
open IsValid isValidá´±
open Validá´¾

step-â‰ˆá´¾ : âˆ€ {Ï„ Î“ Î¸ pc} {c : IConf Î“ Ï„} {c' : FConf Ï„} â†’
             let âŸ¨ Î£ , Î¼ , _ âŸ© = c
                 âŸ¨ Î£' , Î¼' , _ âŸ© = c' in
                 {{validá´¾ : Validá´¾ âŸ¨ Î£ , Î¼ âŸ© }} {{validá´± : Validá´± âˆ¥ Î¼ âˆ¥á´´ Î¸}} â†’
               c â‡“âŸ¨ Î¸ , pc âŸ© c' â†’
               pc â‹¤ A â†’
               âŸ¨ Î£ , Î¼ âŸ© â‰ˆâŸ¨ Î¹ âˆ¥ Î¼ âˆ¥á´´ âŸ©á´¾ âŸ¨ Î£' , Î¼' âŸ©

step-â‰ˆá´¾ (Var Ï„âˆˆÎ“ x) pcâ‹¤A = refl-â‰ˆá´¾

step-â‰ˆá´¾ Unit pcâ‹¤A = refl-â‰ˆá´¾

step-â‰ˆá´¾ (Lbl â„“) pcâ‹¤A = refl-â‰ˆá´¾

step-â‰ˆá´¾ {{isVá´¾}} {{isVá´±}} (Testâ‚ x xâ‚ â„“âŠ‘ refl) pcâ‹¤A =
  let isVá´±â€² âˆ§ isVá´¾â€² âˆ§ _ = valid-invariant x (isVá´¾ âˆ§ isVá´±)
      â‰ˆá´¾â€² = step-â‰ˆá´¾ x pcâ‹¤A
      â‰ˆá´¾â€²â€² = step-â‰ˆá´¾ {{ isVá´¾â€²}} {{isVá´±â€²}} xâ‚ pcâ‹¤A
  in trans-â‰ˆá´¾-Î¹ â‰ˆá´¾â€² â‰ˆá´¾â€²â€²

step-â‰ˆá´¾ {{isVá´¾}} {{isVá´±}} (Testâ‚‚ x xâ‚ â„“âŠ‘ refl) pcâ‹¤A =
  let isVá´±â€²â€² âˆ§ isVá´¾â€² âˆ§ isVá´±â€² = valid-invariant x (isVá´¾ âˆ§ isVá´±)
      â‰ˆá´¾â€² = step-â‰ˆá´¾ x pcâ‹¤A
      â‰ˆá´¾â€²â€² = step-â‰ˆá´¾ {{ isVá´¾â€² }} {{ isVá´±â€²â€² }} xâ‚ pcâ‹¤A
  in trans-â‰ˆá´¾-Î¹ â‰ˆá´¾â€² â‰ˆá´¾â€²â€²

step-â‰ˆá´¾ Fun pcâ‹¤A = refl-â‰ˆá´¾

step-â‰ˆá´¾ {{isVá´¾}} {{isVá´±}} (App xâ‚ xâ‚‚ refl xâ‚ƒ) pcâ‹¤A =
  let isVâ‚á´± âˆ§ isVá´¾â€² âˆ§ isVá´±â€² = valid-invariant xâ‚ (isVá´¾ âˆ§ isVá´±)
      _ âˆ§ isVá´¾â€²â€² âˆ§ isVâ±½ = valid-invariant xâ‚‚ (isVá´¾â€² âˆ§ isVâ‚á´±)
      â‰ˆá´¾â€² = step-â‰ˆá´¾ xâ‚ pcâ‹¤A
      â‰ˆá´¾â€²â€² = step-â‰ˆá´¾ {{ isVá´¾â€² }} {{ isVâ‚á´± }} xâ‚‚ pcâ‹¤A
      isVá´±â€²â€² = wken-valid _ (step-â‰¤ xâ‚‚) isVá´±â€²
      â‰ˆá´¾â€²â€²â€² = step-â‰ˆá´¾ {{ isVá´¾â€²â€² }} {{  isVâ±½ âˆ§ isVá´±â€²â€²  }} xâ‚ƒ (join-â‹¤â‚ pcâ‹¤A)
  in trans-â‰ˆá´¾-Î¹ â‰ˆá´¾â€² (trans-â‰ˆá´¾-Î¹ â‰ˆá´¾â€²â€² â‰ˆá´¾â€²â€²â€²)

step-â‰ˆá´¾ {{isVá´¾}} {{isVá´±}} (Wken p x) pcâ‹¤A = step-â‰ˆá´¾ {{ isVá´¾ }} {{ slice-validá´± _ p isVá´± }} x pcâ‹¤A

step-â‰ˆá´¾ (Inl x) pcâ‹¤A = step-â‰ˆá´¾ x pcâ‹¤A

step-â‰ˆá´¾ (Inr x) pcâ‹¤A = step-â‰ˆá´¾ x pcâ‹¤A

step-â‰ˆá´¾ {{isVá´¾}} {{isVá´±}} (Caseâ‚ xâ‚ refl xâ‚‚) pcâ‹¤A =
  let isVá´±â€² âˆ§ isVá´¾â€² âˆ§ isVâ±½ = valid-invariant xâ‚ (isVá´¾ âˆ§ isVá´±)
      â‰ˆá´¾â€² = step-â‰ˆá´¾ xâ‚ pcâ‹¤A
      â‰ˆá´¾â€²â€² = step-â‰ˆá´¾ {{ isVá´¾â€² }} {{ isVâ±½ âˆ§ isVá´±â€² }} xâ‚‚ (join-â‹¤â‚ pcâ‹¤A)
  in trans-â‰ˆá´¾-Î¹ â‰ˆá´¾â€² â‰ˆá´¾â€²â€²

step-â‰ˆá´¾ {{isVá´¾}} {{isVá´±}} (Caseâ‚‚ x refl xâ‚) pcâ‹¤A =
  let isVá´±â€² âˆ§ isVá´¾â€² âˆ§ isVâ±½ = valid-invariant x (isVá´¾ âˆ§ isVá´±)
      â‰ˆá´¾â€² = step-â‰ˆá´¾ x pcâ‹¤A
      â‰ˆá´¾â€²â€² = step-â‰ˆá´¾ {{ isVá´¾â€² }} {{ isVâ±½ âˆ§ isVá´±â€² }} xâ‚ (join-â‹¤â‚ pcâ‹¤A)
  in trans-â‰ˆá´¾-Î¹ â‰ˆá´¾â€² â‰ˆá´¾â€²â€²

step-â‰ˆá´¾ {{isVá´¾}} {{isVá´±}} (Pair x xâ‚) pcâ‹¤A =
  let isVá´±â€² âˆ§ isVá´¾â€² âˆ§ _ = valid-invariant x (isVá´¾ âˆ§ isVá´±)
      â‰ˆá´¾â€² = step-â‰ˆá´¾ x pcâ‹¤A
      â‰ˆá´¾â€²â€² = step-â‰ˆá´¾ {{ isVá´¾â€² }} {{ isVá´±â€² }} xâ‚ pcâ‹¤A
  in trans-â‰ˆá´¾-Î¹ â‰ˆá´¾â€² â‰ˆá´¾â€²â€²

step-â‰ˆá´¾ (Fst x refl) pcâ‹¤A = step-â‰ˆá´¾ x pcâ‹¤A

step-â‰ˆá´¾ (Snd x xâ‚) pcâ‹¤A = step-â‰ˆá´¾ x pcâ‹¤A

step-â‰ˆá´¾ (LabelOf x) pcâ‹¤A = step-â‰ˆá´¾ x pcâ‹¤A

step-â‰ˆá´¾ GetLabel pcâ‹¤A = refl-â‰ˆá´¾

step-â‰ˆá´¾ {{ isVá´¾ }} {{isVá´±}} (Taint refl x xâ‚ pc'âŠ‘pc'') pcâ‹¤A =
  let isVá´±â€² âˆ§ isVá´¾â€² âˆ§ _ = valid-invariant x (isVá´¾ âˆ§ isVá´±)
      â‰ˆá´¾â€² = step-â‰ˆá´¾ x pcâ‹¤A
      â‰ˆá´¾â€²â€² = step-â‰ˆá´¾ {{ isVá´¾â€² }} {{ isVá´±â€² }} xâ‚ (join-â‹¤â‚ pcâ‹¤A)
  in trans-â‰ˆá´¾-Î¹ â‰ˆá´¾â€² â‰ˆá´¾â€²â€²

step-â‰ˆá´¾ (LabelOfRef x eq) pcâ‹¤A = step-â‰ˆá´¾ x pcâ‹¤A

step-â‰ˆá´¾ {{isVá´¾}} {{isVá´±}} (New x) pcâ‹¤A =
  let âŸ¨ â‰ˆË¢ , â‰ˆá´´ âŸ© = step-â‰ˆá´¾ x pcâ‹¤A
      _ âˆ§ âŸ¨ isVË¢â€² , isVá´´â€² âŸ© âˆ§ _ = valid-invariant x (isVá´¾ âˆ§ isVá´±)
      â‰ˆË¢â€² = updateá´´-â‰ˆË¢ {{ isVË¢â€² }} (trans-â‹¤ (step-âŠ‘ x) pcâ‹¤A) in
      âŸ¨ trans-â‰ˆË¢-Î¹ (step-â‰¤ x) â‰ˆË¢ â‰ˆË¢â€² , â‰ˆá´´ âŸ©

step-â‰ˆá´¾ (Read x xâ‚ eq) pcâ‹¤A = step-â‰ˆá´¾ x pcâ‹¤A

step-â‰ˆá´¾ {{isVá´¾}} {{isVá´±}} (Write x âŠ‘â‚ xâ‚ âŠ‘â‚‚ w) pcâ‹¤A =
  let isVá´±â€² âˆ§ isVá´¾â€² âˆ§ _ = valid-invariant x (isVá´¾ âˆ§ isVá´±)
      isVá´±â€²â€² âˆ§ âŸ¨ isVË¢â€² , isVá´´â€² âŸ© âˆ§ _ = valid-invariant xâ‚ (isVá´¾â€² âˆ§ isVá´±â€²)
      â‰ˆá´¾â€² = step-â‰ˆá´¾ x pcâ‹¤A
      â‰ˆá´¾â€²â€² = step-â‰ˆá´¾ {{ isVá´¾â€² }} {{ isVá´±â€² }} xâ‚ pcâ‹¤A
      â„“â‹¤A = trans-â‹¤ (trans-âŠ‘ (step-âŠ‘ x) âŠ‘â‚) pcâ‹¤A
      â‰ˆá´¾â€²â€²â€² = âŸ¨ updateá´´-â‰ˆË¢ {{ isVË¢â€² }} â„“â‹¤A , refl-â‰ˆá´´ {{ isVá´´â€² }} âŸ©
  in trans-â‰ˆá´¾-Î¹ â‰ˆá´¾â€² (trans-â‰ˆá´¾-Î¹ â‰ˆá´¾â€²â€² â‰ˆá´¾â€²â€²â€²)

step-â‰ˆá´¾ (LabelOfRef-FS x xâ‚ eq) pcâ‹¤A = step-â‰ˆá´¾ x pcâ‹¤A

-- TODO: Do we need all of them implicits?
step-â‰ˆá´¾ {{isVá´¾}} {{isVá´±}} (New-FS x) pcâ‹¤A =
  let âŸ¨ â‰ˆË¢ , â‰ˆá´´ âŸ© = step-â‰ˆá´¾ {{ isVá´¾ }} {{isVá´±}} x pcâ‹¤A
      isVá´¾â€² âˆ§ _ = validá´¾-â‡“ x (isVá´¾ âˆ§ isVá´±)
      â‰ˆË¢â€² = trans-â‰ˆË¢-Î¹ (step-â‰¤ x) â‰ˆË¢ (refl-â‰ˆË¢ {{ validË¢ isVá´¾â€² }}) in
      âŸ¨ â‰ˆË¢â€² , snoc-â‰ˆá´´ _ â‰ˆá´´ âŸ©

step-â‰ˆá´¾ (Read-FS x xâ‚ eq) pcâ‹¤A = step-â‰ˆá´¾ x pcâ‹¤A

step-â‰ˆá´¾ {{isVá´¾}} {{isVá´±}} (Write-FS x xâ‚ âˆˆâ‚ âŠ‘â‚ refl w) pcâ‹¤A =
  let isVá´±â€² âˆ§ isVá´¾â€² âˆ§ _ = valid-invariant x (isVá´¾ âˆ§ isVá´±)
      isVá´±â€²â€² âˆ§ isVá´¾â€²â€² âˆ§ _ = valid-invariant xâ‚ (isVá´¾â€² âˆ§ isVá´±â€²)
      â‰ˆá´¾â€² = step-â‰ˆá´¾ x pcâ‹¤A
      â‰ˆá´¾â€²â€² = step-â‰ˆá´¾ {{ isVá´¾â€² }} {{ isVá´±â€² }} xâ‚ pcâ‹¤A
      vâ‰ˆ = Valueá´´ (trans-â‹¤ (trans-âŠ‘ (step-âŠ‘ x) âŠ‘â‚) pcâ‹¤A) (join-â‹¤â‚ (trans-â‹¤ (step-âŠ‘ x) pcâ‹¤A))
      â‰ˆá´¾â€²â€²â€² = writeá´´-â‰ˆá´´ {{ validá´´ isVá´¾â€²â€² }} âˆˆâ‚ w vâ‰ˆ
  in trans-â‰ˆá´¾-Î¹ â‰ˆá´¾â€² (trans-â‰ˆá´¾-Î¹ â‰ˆá´¾â€²â€² âŸ¨ refl-â‰ˆË¢ {{ validË¢ isVá´¾â€²â€² }} , â‰ˆá´¾â€²â€²â€² âŸ©)
  where open Validá´¾

step-â‰ˆá´¾ (Id x) pcâ‹¤A = step-â‰ˆá´¾ x pcâ‹¤A

step-â‰ˆá´¾ (UnId x eq) pcâ‹¤A = step-â‰ˆá´¾ x pcâ‹¤A

wken-âˆƒ : âˆ€ {Ï„ Î² Î²'} {câ‚ câ‚‚ : FConf Ï„} â†’
         Î² âŠ† Î²' â†’ (x : âˆƒ (Î» Î²'' â†’ Î²' âŠ† Î²'' Ã— câ‚ â‰ˆâŸ¨ Î²'' âŸ©á¶œ câ‚‚)) â†’
         âˆƒ (Î» Î²'' â†’ Î² âŠ† Î²'' Ã— câ‚ â‰ˆâŸ¨ Î²'' âŸ©á¶œ câ‚‚)
wken-âˆƒ Î²âŠ†Î²' (Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ â‰ˆâ‚)  = Î²'' âˆ§ (trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'') âˆ§ â‰ˆâ‚

mutual

  -- TINI for low steps
  tiniá´¸ : âˆ€ {pc Î² Ï„ Î“ Î¼â‚ Î¼â‚‚ Î£â‚ Î£â‚‚ e} {Î¸â‚ Î¸â‚‚ : Env Î“} {câ‚' câ‚‚' : FConf Ï„} â†’
                    let câ‚ = âŸ¨ Î£â‚ , Î¼â‚ , e âŸ©
                        câ‚‚ = âŸ¨ Î£â‚‚ , Î¼â‚‚ , e âŸ© in
                    {{validâ‚ : Valid-Inputs câ‚ Î¸â‚}} {{validâ‚‚ : Valid-Inputs câ‚‚ Î¸â‚‚}} â†’
                    câ‚ â‡“âŸ¨ Î¸â‚ , pc âŸ© câ‚' â†’
                    câ‚‚ â‡“âŸ¨ Î¸â‚‚ , pc âŸ© câ‚‚' â†’
                    âŸ¨ Î£â‚ , Î¼â‚ âŸ© â‰ˆâŸ¨ Î² âŸ©á´¾ âŸ¨ Î£â‚‚ , Î¼â‚‚ âŸ© â†’
                    Î¸â‚ â‰ˆâŸ¨ Î² âŸ©á´± Î¸â‚‚ â†’
                    pc âŠ‘ A â†’
                    âˆƒ (Î» Î²' â†’ Î² âŠ† Î²' Ã— câ‚' â‰ˆâŸ¨ Î²' âŸ©á¶œ câ‚‚')

  tiniá´¸ (Var Ï„âˆˆÎ“ refl) (Var .Ï„âˆˆÎ“ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ â‰ˆá´¾ , â‰ˆâ±½-âŠ‘ _ vâ‚â‰ˆvâ‚‚ âŸ©
    where vâ‚â‰ˆvâ‚‚ = lookup-â‰ˆâ±½ Ï„âˆˆÎ“ Î¸â‚â‰ˆÎ¸â‚‚

  tiniá´¸ Unit Unit â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ â‰ˆá´¾ , Valueá´¸ pcâŠ‘A Unit âŸ©

  tiniá´¸ (Lbl â„“) (Lbl .â„“) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ â‰ˆá´¾ , Valueá´¸ pcâŠ‘A (Lbl â„“) âŸ©

  --------------------------------------------------------------------------------
  -- Test cases

  -- Both true
  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨  â‰ˆá´¾â€² , Valueá´¸ _ (Lbl â„“â‚) âŸ©
    with tiniá´¸ {{ validá´¾-â‡“ xâ‚ isVâ‚ }} {{ validá´¾-â‡“ yâ‚ isVâ‚‚ }} xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A

  tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
      = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´¸ (join-âŠ‘' pâ‚ pâ‚‚) (Trueá´¸ pcâŠ‘A) âŸ©

  tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ p (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
      = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´´ (join-â‹¤â‚‚ Â¬pâ‚) (join-â‹¤â‚‚ Â¬pâ‚‚) âŸ©

  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ©
    with tiniá´¸ {{ validá´¾-â‡“ xâ‚ isVâ‚ }} {{ validá´¾-â‡“ yâ‚ isVâ‚‚ }} xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... |  Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , vâ‰ˆ âŸ©
    = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´´ (join-â‹¤â‚ pcâ‹¤â„“â‚') (join-â‹¤â‚ pcâ‹¤â„“â‚‚') âŸ©

    -- True vs False
  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | _ âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ _ (Lbl â„“â‚) âŸ©
    with tiniá´¸ {{ validá´¾-â‡“ xâ‚ ( isVâ‚) }} {{ validá´¾-â‡“ yâ‚ (isVâ‚‚) }} xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A

  tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | _ âˆ§ _ âˆ§  âŸ¨ â‰ˆá´¾â€² , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | _ âˆ§ _ âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
      = âŠ¥-elim (â„“â‚â‹¤â„“â‚‚ â„“â‚âŠ‘â„“â‚‚)

  tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ p (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
      = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´´ (join-â‹¤â‚‚ Â¬pâ‚) (join-â‹¤â‚‚ Â¬pâ‚‚) âŸ©

  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ©
    with tiniá´¸ {{ validá´¾-â‡“ xâ‚ ( isVâ‚) }} {{ validá´¾-â‡“ yâ‚ (isVâ‚‚) }}  xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´´ (join-â‹¤â‚ pcâ‹¤â„“â‚') (join-â‹¤â‚ pcâ‹¤â„“â‚‚') âŸ©

  -- False vs True
  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | _ âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ _ (Lbl â„“â‚) âŸ©
    with tiniá´¸ {{ validá´¾-â‡“ xâ‚ ( isVâ‚) }} {{ validá´¾-â‡“ yâ‚ (isVâ‚‚) }} xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A

  tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | _ âˆ§ _ âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | _ âˆ§ _ âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
      = âŠ¥-elim (â„“â‚â‹¤â„“â‚‚ â„“â‚âŠ‘â„“â‚‚)

  tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ p (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
    = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´´ (join-â‹¤â‚‚ Â¬pâ‚) (join-â‹¤â‚‚ Â¬pâ‚‚) âŸ©

  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ©
    with tiniá´¸  {{ validá´¾-â‡“ xâ‚ ( isVâ‚) }} {{ validá´¾-â‡“ yâ‚ (isVâ‚‚) }} xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´´ (join-â‹¤â‚ pcâ‹¤â„“â‚') (join-â‹¤â‚ pcâ‹¤â„“â‚‚') âŸ©

  -- False and False
  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ _ (Lbl â„“â‚) âŸ©
    with tiniá´¸ {{ validá´¾-â‡“ xâ‚ ( isVâ‚) }} {{ validá´¾-â‡“ yâ‚ (isVâ‚‚) }}  xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A

  tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
      = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´¸ (join-âŠ‘' pâ‚ pâ‚‚) (Falseá´¸ pcâŠ‘A) âŸ©

  tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ p (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
      = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´´ (join-â‹¤â‚‚ Â¬pâ‚) (join-â‹¤â‚‚ Â¬pâ‚‚) âŸ©

  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ©
    with tiniá´¸ {{ validá´¾-â‡“ xâ‚ ( isVâ‚) }} {{ validá´¾-â‡“ yâ‚ (isVâ‚‚) }} xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , vâ‰ˆ âŸ©
    = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´´ (join-â‹¤â‚ pcâ‹¤â„“â‚') (join-â‹¤â‚ pcâ‹¤â„“â‚‚') âŸ©

  -- End Test Cases
  --------------------------------------------------------------------------------

  tiniá´¸ Fun Fun â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ â‰ˆá´¾ , Valueá´¸ pcâŠ‘A (Fun Î¸â‚â‰ˆÎ¸â‚‚) âŸ©

  --------------------------------------------------------------------------------
  -- App Cases

  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (App xâ‚ xâ‚‚ eqâ‚ xâ‚ƒ) (App yâ‚ yâ‚‚ eqâ‚‚ yâ‚ƒ) â‰ˆá´¾ Î¸â‰ˆ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‰ˆ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , vâ‚â‰ˆvâ‚‚ âŸ© with valid-invariant xâ‚ ( isVâ‚) | valid-invariant yâ‚ (isVâ‚‚)
  ... | isVâ‚á´±â€² âˆ§ isVâ‚á´¾â€² âˆ§ isVâ‚á´±â€²â€² | isVâ‚‚á´±â€² âˆ§ isVâ‚‚á´¾â€² âˆ§ isVâ‚‚á´±â€²â€²
    with tiniá´¸ {{ isVâ‚á´¾â€² âˆ§ isVâ‚á´±â€² }} {{ isVâ‚‚á´¾â€² âˆ§ isVâ‚‚á´±â€² }} xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‰ˆ) pcâŠ‘A

  -- Public closure
  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (App xâ‚ xâ‚‚ refl xâ‚ƒ) (App yâ‚ yâ‚‚ refl yâ‚ƒ) â‰ˆá´¾ Î¸â‰ˆ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ pcâŠ‘â„“' (Fun Î¸â‰ˆâ€²) âŸ© | isVâ‚á´±â€² âˆ§ isVâ‚á´¾â€² âˆ§ isVâ‚á´±â€²â€² | isVâ‚‚á´±â€² âˆ§ isVâ‚‚á´¾â€² âˆ§ isVâ‚‚á´±â€²â€²
    | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , vâ‚'â‰ˆvâ‚‚' âŸ©
       = let _ âˆ§ isVâ‚á´¾â€²â€² âˆ§ isVâ‚â±½ = valid-invariant xâ‚‚ (isVâ‚á´¾â€² âˆ§ isVâ‚á´±â€²)
             _ âˆ§ isVâ‚‚á´¾â€²â€² âˆ§ isVâ‚‚â±½ = valid-invariant yâ‚‚ (isVâ‚‚á´¾â€² âˆ§ isVâ‚‚á´±â€²)
             viâ‚ = isVâ‚á´¾â€²â€² âˆ§ (isVâ‚â±½ âˆ§ wken-valid _ (step-â‰¤ xâ‚‚) isVâ‚á´±â€²â€²)
             viâ‚‚ = isVâ‚‚á´¾â€²â€² âˆ§ (isVâ‚‚â±½ âˆ§ wken-valid _ (step-â‰¤ yâ‚‚) isVâ‚‚á´±â€²â€²)
             Î¸â‰ˆâ€²â€² = vâ‚'â‰ˆvâ‚‚' âˆ· wken-â‰ˆá´± Î²'âŠ†Î²'' Î¸â‰ˆâ€²
             â‰ˆâ‚ = tini {{ viâ‚ }} {{ viâ‚‚ }} xâ‚ƒ yâ‚ƒ  âŸ¨ â‰ˆá´¾â€²â€² , refl âŸ© Î¸â‰ˆâ€²â€²  in
             wken-âˆƒ (trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'') â‰ˆâ‚


  -- Secret closure
  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (App xâ‚ xâ‚‚ refl xâ‚ƒ) (App yâ‚ yâ‚‚ refl yâ‚ƒ) â‰ˆá´¾ Î¸â‰ˆ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ pcâ‹¤â„“â‚ pcâ‹¤â„“â‚‚ âŸ© | isVâ‚á´±â€² âˆ§ isVâ‚á´¾â€² âˆ§ isVâ‚á´±â€²â€² | isVâ‚‚á´±â€² âˆ§ isVâ‚‚á´¾â€² âˆ§ isVâ‚‚á´±â€²â€²
    | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , vâ‚'â‰ˆvâ‚‚' âŸ©
      = let _ âˆ§ isVâ‚á´¾â€²â€² âˆ§ isVâ‚â±½ = valid-invariant xâ‚‚ (isVâ‚á´¾â€² âˆ§ isVâ‚á´±â€²)
            _ âˆ§ isVâ‚‚á´¾â€²â€² âˆ§ isVâ‚‚â±½ = valid-invariant yâ‚‚ (isVâ‚‚á´¾â€² âˆ§ isVâ‚‚á´±â€²)
            viâ‚ = (isVâ‚á´¾â€²â€² âˆ§ isVâ‚â±½ âˆ§ wken-valid _ (step-â‰¤ xâ‚‚) isVâ‚á´±â€²â€²)
            viâ‚‚ = (isVâ‚‚á´¾â€²â€² âˆ§ isVâ‚‚â±½ âˆ§ wken-valid _ (step-â‰¤ yâ‚‚) isVâ‚‚á´±â€²â€²)
            â‰ˆâ‚ = tiniá´´ {{ viâ‚ }} {{ viâ‚‚ }} â‰ˆá´¾â€²â€² xâ‚ƒ yâ‚ƒ (join-â‹¤â‚‚ pcâ‹¤â„“â‚) (join-â‹¤â‚‚ pcâ‹¤â„“â‚‚) in
            wken-âˆƒ (trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'') â‰ˆâ‚

  -- End App Cases
  --------------------------------------------------------------------------------

  tiniá´¸ {{ isVâ‚á´¾ âˆ§ isVâ‚á´± }} {{ isVâ‚‚á´¾ âˆ§ isVâ‚‚á´±}} (Wken p x) (Wken .p y) â‰ˆá´¾ Î¸â‰ˆ pcâŠ‘A =
    let Î¸â‰ˆâ€² = slice-â‰ˆá´± Î¸â‰ˆ p
        isVâ‚á´±â€² = slice-validá´± _ p isVâ‚á´±
        isVâ‚‚á´±â€² = slice-validá´± _ p isVâ‚‚á´± in
        tiniá´¸ {{ isVâ‚á´¾ âˆ§ isVâ‚á´±â€² }} {{ isVâ‚‚á´¾ âˆ§ isVâ‚‚á´±â€² }} x y â‰ˆá´¾ Î¸â‰ˆâ€² pcâŠ‘A

  tiniá´¸ (Inl x) (Inl xâ‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , vâ‚â‰ˆvâ‚‚ âŸ© =  Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ pcâŠ‘A (Inl vâ‚â‰ˆvâ‚‚) âŸ©

  tiniá´¸ (Inr x) (Inr xâ‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , vâ‚â‰ˆvâ‚‚ âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ pcâŠ‘A (Inr vâ‚â‰ˆvâ‚‚) âŸ©


  --------------------------------------------------------------------------------
  -- Case inspection

  -- Both left
  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Caseâ‚ xâ‚ refl xâ‚‚) (Caseâ‚ yâ‚ refl yâ‚‚) â‰ˆá´¾ Î¸â‰ˆ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‰ˆ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Inl vâ‰ˆ) âŸ© =
    let isVâ‚á´±â€² âˆ§ isVâ‚á´¾â€² âˆ§ isVâ‚â±½ = valid-invariant xâ‚ (isVâ‚)
        isVâ‚‚á´±â€² âˆ§ isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ = valid-invariant yâ‚ (isVâ‚‚)
        viâ‚ = isVâ‚á´¾â€² âˆ§ isVâ‚â±½ âˆ§ isVâ‚á´±â€²
        viâ‚‚ = isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ âˆ§ isVâ‚‚á´±â€²
        Î¸â‰ˆâ€² = vâ‰ˆ âˆ· wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‰ˆ  in
        wken-âˆƒ Î²âŠ†Î²' (tini {{ viâ‚ }} {{ viâ‚‚ }} xâ‚‚ yâ‚‚ âŸ¨ â‰ˆá´¾â€² , refl âŸ© Î¸â‰ˆâ€²)

  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© =
    let isVâ‚á´±â€² âˆ§ isVâ‚á´¾â€² âˆ§ isVâ‚â±½ = valid-invariant xâ‚ (isVâ‚)
        isVâ‚‚á´±â€² âˆ§ isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ = valid-invariant yâ‚ (isVâ‚‚)
        viâ‚ = isVâ‚á´¾â€² âˆ§ isVâ‚â±½ âˆ§ isVâ‚á´±â€²
        viâ‚‚ = isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ âˆ§ isVâ‚‚á´±â€² in
        wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ viâ‚ }} {{ viâ‚‚ }} â‰ˆá´¾â€² xâ‚‚ yâ‚‚ (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A))

  -- Left vs right
  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Caseâ‚ xâ‚ refl xâ‚‚) (Caseâ‚‚ yâ‚ refl yâ‚‚) â‰ˆá´¾ Î¸â‰ˆ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‰ˆ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A () âŸ©   -- Public scrutinee with different injections (impossible)
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© =
    let isVâ‚á´±â€² âˆ§ isVâ‚á´¾â€² âˆ§ isVâ‚â±½ = valid-invariant xâ‚ (isVâ‚)
        isVâ‚‚á´±â€² âˆ§ isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ = valid-invariant yâ‚ (isVâ‚‚)
        viâ‚ = isVâ‚á´¾â€² âˆ§ isVâ‚â±½ âˆ§ isVâ‚á´±â€²
        viâ‚‚ = isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ âˆ§ isVâ‚‚á´±â€² in
        wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ viâ‚ }} {{ viâ‚‚ }} â‰ˆá´¾â€² xâ‚‚ yâ‚‚ (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A)) -- Secret scrutinee

  -- Right vs left (like above)
  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Caseâ‚‚ xâ‚ refl xâ‚‚) (Caseâ‚ yâ‚ refl yâ‚‚) â‰ˆá´¾ Î¸â‰ˆ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‰ˆ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A () âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© =
    let isVâ‚á´±â€² âˆ§ isVâ‚á´¾â€² âˆ§ isVâ‚â±½ = valid-invariant xâ‚ (isVâ‚)
        isVâ‚‚á´±â€² âˆ§ isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ = valid-invariant yâ‚ (isVâ‚‚)
        viâ‚ = isVâ‚á´¾â€² âˆ§ isVâ‚â±½ âˆ§ isVâ‚á´±â€²
        viâ‚‚ = isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ âˆ§ isVâ‚‚á´±â€² in
        wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ viâ‚ }} {{ viâ‚‚ }} â‰ˆá´¾â€² xâ‚‚ yâ‚‚ (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A)) -- Secret scrutinee

  -- Both right
  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Caseâ‚‚ xâ‚ refl xâ‚‚) (Caseâ‚‚ yâ‚ refl yâ‚‚) â‰ˆá´¾ Î¸â‰ˆ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‰ˆ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Inr vâ‰ˆ) âŸ© =
    let isVâ‚á´±â€² âˆ§ isVâ‚á´¾â€² âˆ§ isVâ‚â±½ = valid-invariant xâ‚ (isVâ‚)
        isVâ‚‚á´±â€² âˆ§ isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ = valid-invariant yâ‚ (isVâ‚‚)
        viâ‚ = isVâ‚á´¾â€² âˆ§ isVâ‚â±½ âˆ§ isVâ‚á´±â€²
        viâ‚‚ = isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ âˆ§ isVâ‚‚á´±â€²
        Î¸â‰ˆâ€² = vâ‰ˆ âˆ· wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‰ˆ  in
        wken-âˆƒ Î²âŠ†Î²' (tini {{ viâ‚ }} {{ viâ‚‚ }} xâ‚‚ yâ‚‚ âŸ¨ â‰ˆá´¾â€² , refl âŸ© Î¸â‰ˆâ€²)


  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© =
    let isVâ‚á´±â€² âˆ§ isVâ‚á´¾â€² âˆ§ isVâ‚â±½ = valid-invariant xâ‚ (isVâ‚)
        isVâ‚‚á´±â€² âˆ§ isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ = valid-invariant yâ‚ (isVâ‚‚)
        viâ‚ = isVâ‚á´¾â€² âˆ§ isVâ‚â±½ âˆ§ isVâ‚á´±â€²
        viâ‚‚ = isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ âˆ§ isVâ‚‚á´±â€² in
        wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ viâ‚ }} {{ viâ‚‚ }} â‰ˆá´¾â€² xâ‚‚ yâ‚‚ (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A))

  -- End case inspection cases
  --------------------------------------------------------------------------------

  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Pair xâ‚ xâ‚‚) (Pair yâ‚ yâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , vâ‚â‰ˆvâ‚' âŸ© with tiniá´¸ {{ validá´¾-â‡“ xâ‚ ( isVâ‚) }} {{ validá´¾-â‡“ yâ‚ (isVâ‚‚) }} xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , vâ‚‚â‰ˆvâ‚‚' âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ â‰ˆá´¾â€²â€² , Valueá´¸ pcâŠ‘A (Pair (wken-â‰ˆâ±½ Î²'âŠ†Î²'' vâ‚â‰ˆvâ‚') vâ‚‚â‰ˆvâ‚‚') âŸ©

  tiniá´¸ (Fst x refl) (Fst xâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Pair vâ‚â‰ˆvâ‚' vâ‚‚â‰ˆvâ‚‚') âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , â‰ˆâ±½-âŠ‘ _ vâ‚â‰ˆvâ‚' âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

  tiniá´¸ (Snd x refl) (Snd xâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Pair vâ‚â‰ˆvâ‚' vâ‚‚â‰ˆvâ‚‚') âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , â‰ˆâ±½-âŠ‘ _ vâ‚‚â‰ˆvâ‚‚' âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

  tiniá´¸ (LabelOf x) (LabelOf xâ‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A vâ‚â‰ˆvâ‚‚ âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Lbl _) âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ©

  tiniá´¸ GetLabel GetLabel â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ â‰ˆá´¾ , Valueá´¸ pcâŠ‘A (Lbl _) âŸ©

  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Taint refl xâ‚ xâ‚‚ âŠ‘â‚) (Taint refl yâ‚ yâ‚‚ âŠ‘â‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Lbl â„“) âŸ© =
    let isVâ‚á´±â€² âˆ§ isVâ‚á´¾â€² âˆ§ isVâ‚â±½ = valid-invariant xâ‚ (isVâ‚)
        isVâ‚‚á´±â€² âˆ§ isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ = valid-invariant yâ‚ (isVâ‚‚)
        viâ‚ = (isVâ‚á´¾â€² âˆ§ isVâ‚á´±â€²)
        viâ‚‚ = (isVâ‚‚á´¾â€² âˆ§ isVâ‚‚á´±â€²) in
        wken-âˆƒ Î²âŠ†Î²' (tini {{ viâ‚ }} {{ viâ‚‚ }} xâ‚‚ yâ‚‚ âŸ¨ â‰ˆá´¾â€² , refl âŸ© (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚))

  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© =
    let isVâ‚á´±â€² âˆ§ isVâ‚á´¾â€² âˆ§ isVâ‚â±½ = valid-invariant xâ‚ (isVâ‚)
        isVâ‚‚á´±â€² âˆ§ isVâ‚‚á´¾â€² âˆ§ isVâ‚‚â±½ = valid-invariant yâ‚ (isVâ‚‚)
        viâ‚ = (isVâ‚á´¾â€² âˆ§ isVâ‚á´±â€²)
        viâ‚‚ = (isVâ‚‚á´¾â€² âˆ§ isVâ‚‚á´±â€²) in
        wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ viâ‚ }} {{ viâ‚‚ }} â‰ˆá´¾â€² xâ‚‚ yâ‚‚ (trans-â‹¤ âŠ‘â‚ â„“â‚â‹¤A) (trans-â‹¤ âŠ‘â‚‚ â„“â‚‚â‹¤A))


  tiniá´¸ (LabelOfRef xâ‚ refl) (LabelOfRef xâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Ref-Iá´¸ â„“âŠ‘Aâ‚) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , (Valueá´¸ (join-âŠ‘' â„“âŠ‘Aâ‚ â„“âŠ‘A) (Lbl _)) âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Ref-Iá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , (Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A)) âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A) âŸ©

  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (New xâ‚) (New yâ‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , Valueá´´ â‹¤â‚ â‹¤â‚‚  âŸ© =
    let isVâ‚á´¾â€² âˆ§ _  = validá´¾-â‡“ xâ‚ isVâ‚
        isVâ‚‚á´¾â€² âˆ§ _  = validá´¾-â‡“ yâ‚ isVâ‚‚
        Î£â‚â‰ˆ = updateá´´-â‰ˆË¢ {{ validË¢ isVâ‚á´¾â€² }} â‹¤â‚
        Î£â‚‚â‰ˆ = updateá´´-â‰ˆË¢ {{ validË¢ isVâ‚‚á´¾â€² }} â‹¤â‚‚
        Î£â‰ˆâ€² = square-â‰ˆË¢-Î¹ Î£â‰ˆ Î£â‚â‰ˆ Î£â‚‚â‰ˆ âŠ†á´¿-Î¹ âŠ†á´°-Î¹
        vâ‰ˆâ€² = Valueá´¸ pcâŠ‘A (Ref-Iá´´ â‹¤â‚ â‹¤â‚‚) in
        Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆâ€² , Î¼â‰ˆ âŸ© , vâ‰ˆâ€² âŸ©
    where open _â‰ˆâŸ¨_âŸ©á´´_ Î¼â‰ˆ

  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , Valueá´¸ â„“âŠ‘A râ‰ˆ âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆâ€² , Î¼â‰ˆ âŸ© , vâ‰ˆâ€² âŸ©
      where Mâ‰ˆ = getá´¸ Î£â‰ˆ â„“âŠ‘A
            Î£â‰ˆâ€² = updateá´¸-â‰ˆË¢ Î£â‰ˆ (new-â‰ˆá´¹ Mâ‰ˆ  râ‰ˆ)
            vâ‰ˆâ€² = Valueá´¸ pcâŠ‘A (Ref-Iá´¸â€² â„“âŠ‘A âˆ¥ Mâ‰ˆ âˆ¥-â‰¡)

  -- Read public reference
  tiniá´¸ (Read xâ‚ nâˆˆMâ‚ refl) (Read xâ‚‚ nâˆˆMâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , Valueá´¸ â„“âŠ‘A (Ref-Iá´¸ â„“'âŠ‘A) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆ âŸ©
       where Mâ‰ˆ = getá´¸ Î£â‰ˆ â„“'âŠ‘A
             vâ‰ˆ = Valueá´¸ (join-âŠ‘' â„“'âŠ‘A â„“âŠ‘A) (read-â‰ˆá´¹ Mâ‰ˆ nâˆˆMâ‚ nâˆˆMâ‚‚)

  -- Read secret reference.
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Ref-Iá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , vâ‰ˆ âŸ©
    where vâ‰ˆ = Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A)

  -- Read secret-dependent reference
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , vâ‰ˆ âŸ©
    where vâ‰ˆ = Valueá´´ (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A)

  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Write xâ‚ âŠ‘â‚ xâ‚‚ â„“â‚‚âŠ‘â„“ wâ‚) (Write yâ‚ âŠ‘â‚‚ yâ‚‚ â„“â‚‚âŠ‘â„“' wâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    with  validá´¾-â‡“ xâ‚ isVâ‚ | validá´¾-â‡“ yâ‚ isVâ‚‚ | tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A

  -- Write low-data to a secret-dependent reference
  ... | isVâ‚â€² | isVâ‚‚â€² | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ©
    with tiniá´¸ {{ isVâ‚â€² }} {{ isVâ‚‚â€² }} xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ©  , vâ‰ˆ âŸ© =
    let isVâ‚á´¾â€²â€² âˆ§ _  = validá´¾-â‡“ xâ‚‚ isVâ‚â€²
        isVâ‚‚á´¾â€²â€² âˆ§ _  = validá´¾-â‡“ yâ‚‚ isVâ‚‚â€²
        Î£â‚â‰ˆ = updateá´´-â‰ˆË¢ {{ validË¢ isVâ‚á´¾â€²â€² }} (trans-â‹¤ âŠ‘â‚ â„“â‚â‹¤A)
        Î£â‚‚â‰ˆ = updateá´´-â‰ˆË¢ {{ validË¢ isVâ‚‚á´¾â€²â€² }} (trans-â‹¤ âŠ‘â‚‚ â„“â‚‚â‹¤A)
        Î£â‰ˆâ€² = square-â‰ˆË¢-Î¹ Î£â‰ˆ Î£â‚â‰ˆ Î£â‚‚â‰ˆ âŠ†á´¿-Î¹ âŠ†á´°-Î¹ in
        Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆâ€² , Î¼â‰ˆ âŸ© , Valueá´¸ pcâŠ‘A Unit âŸ©
    where open _â‰ˆâŸ¨_âŸ©á´´_ Î¼â‰ˆ

  -- Write low data to low reference
  tiniá´¸ {{isVâ‚}} {{isVâ‚‚}} (Write xâ‚ â„“'âŠ‘â„“ xâ‚‚ â„“â‚‚âŠ‘â„“ wâ‚) (Write yâ‚ â„“'âŠ‘â„“' yâ‚‚ â„“â‚‚âŠ‘â„“' wâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | isVâ‚â€² | isVâ‚‚â€² | Î²' âˆ§ Î²âŠ†Î²'  âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Ref-Iá´¸ âŠ‘â‚) âŸ©
    with tiniá´¸ {{ isVâ‚â€² }} {{ isVâ‚‚â€² }} xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆâ€² , Î¼â‰ˆ âŸ© , Valueá´¸ pcâŠ‘A Unit âŸ©
      where Mâ‰ˆ = getá´¸ Î£â‰ˆ âŠ‘â‚
            Î£â‰ˆâ€² = updateá´¸-â‰ˆË¢ Î£â‰ˆ (update-â‰ˆá´¹ Mâ‰ˆ (extract-â‰ˆá´¿ vâ‰ˆ (trans-âŠ‘ â„“â‚‚âŠ‘â„“ âŠ‘â‚)) wâ‚ wâ‚‚)

  -- Write low data to high reference
  tiniá´¸  {{isVâ‚}} {{isVâ‚‚}} (Write xâ‚ âŠ‘â‚ xâ‚‚ âŠ‘â‚â€² wâ‚) (Write yâ‚ âŠ‘â‚‚ yâ‚‚ âŠ‘â‚‚â€² wâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | isVâ‚â€² | isVâ‚‚â€² | Î²' âˆ§ Î²âŠ†Î²'  âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Ref-Iá´´ â‹¤â‚ â‹¤â‚‚) âŸ©
    with tiniá´¸ {{ isVâ‚â€² }} {{ isVâ‚‚â€² }} xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆ âŸ© =
    let isVâ‚á´¾â€²â€² âˆ§ _  = validá´¾-â‡“ xâ‚‚ isVâ‚â€²
        isVâ‚‚á´¾â€²â€² âˆ§ _  = validá´¾-â‡“ yâ‚‚ isVâ‚‚â€²
        Î£â‚â‰ˆ = updateá´´-â‰ˆË¢ {{ validË¢ isVâ‚á´¾â€²â€² }} â‹¤â‚
        Î£â‚‚â‰ˆ = updateá´´-â‰ˆË¢ {{ validË¢ isVâ‚‚á´¾â€²â€² }} â‹¤â‚‚
        Î£â‰ˆâ€² = square-â‰ˆË¢-Î¹ Î£â‰ˆ Î£â‚â‰ˆ Î£â‚‚â‰ˆ âŠ†á´¿-Î¹ âŠ†á´°-Î¹ in
        Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆâ€² , Î¼â‰ˆ âŸ© , Valueá´¸ pcâŠ‘A Unit âŸ©
    where open _â‰ˆâŸ¨_âŸ©á´´_ Î¼â‰ˆ

  tiniá´¸ (Id xâ‚) (Id xâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with  tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , vâ‰ˆ âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ pcâŠ‘A (Id vâ‰ˆ) âŸ©

  tiniá´¸ (UnId xâ‚ refl) (UnId xâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´¸ â„“âŠ‘A (Id vâ‰ˆ) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , â‰ˆâ±½-âŠ‘ _ vâ‰ˆ âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

  tiniá´¸ (LabelOfRef-FS xâ‚ âˆˆâ‚ refl) (LabelOfRef-FS xâ‚‚ âˆˆâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , Valueá´¸ â„“âŠ‘A (Ref-S âˆˆÎ²') âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆ âŸ©
    where vâ‰ˆ = â‰ˆâ±½-âŠ‘ _ (label-of-â‰ˆâ±½ (readá´¸-â‰ˆâ±½ âˆˆÎ²' âˆˆâ‚ âˆˆâ‚‚ Î¼â‰ˆ))
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

  tiniá´¸ (New-FS {Î¼' = Î¼â‚'} xâ‚) (New-FS {Î¼' = Î¼â‚‚'} xâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆ  âŸ© = Î²'' âˆ§ Î²âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ wken-â‰ˆË¢ âŠ†â‚ Î£â‰ˆ , Î¼â‰ˆâ€² âŸ© , wken-â‰ˆâ±½ âŠ†â‚‚ vâ‰ˆâ€² âŸ©
      where
        instance _ = _â‰Ÿ_
                 _ = â‰ˆ-# Î¼â‰ˆ
        Î²â‚ =  âˆ¥ Î¼â‚' âˆ¥á´´ â†” âˆ¥ Î¼â‚‚' âˆ¥á´´
        Î²'' = Î²' âˆ£á´® Î²â‚
        âŠ†â‚ = âˆ£á´®-âŠ†â‚ Î²' Î²â‚
        âŠ†â‚‚ = âˆ£á´®-âŠ†â‚‚ Î²' Î²â‚
        Î²âŠ†Î²'' = trans-âŠ† Î²âŠ†Î²' âŠ†â‚
        Î¼â‰ˆâ€² = newá´¸-â‰ˆá´´ vâ‰ˆ Î¼â‰ˆ
        vâ‰ˆâ€² = Valueá´¸ pcâŠ‘A (Ref-S (â†”-âˆˆáµ— âˆ¥ Î¼â‚' âˆ¥á´´ âˆ¥ Î¼â‚‚' âˆ¥á´´))

  tiniá´¸ (Read-FS xâ‚ âˆˆâ‚ refl) (Read-FS xâ‚‚ âˆˆâ‚‚ refl) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A

  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , vâ‰ˆ âŸ©
    where vâ‰ˆ = Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A)

  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨  âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , Valueá´¸ â„“âŠ‘A (Ref-S âˆˆÎ²) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , â‰ˆâ±½-âŠ‘ _ vâ‰ˆ âŸ©
       where vâ‰ˆ = readá´¸-â‰ˆâ±½ âˆˆÎ² âˆˆâ‚ âˆˆâ‚‚ Î¼â‰ˆ

  tiniá´¸  {{isVâ‚}} {{isVâ‚‚}} (Write-FS xâ‚ xâ‚‚ âˆˆâ‚ âŠ‘â‚ refl wâ‚) (Write-FS yâ‚ yâ‚‚ âˆˆâ‚‚ âŠ‘â‚‚ refl wâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    with  validá´¾-â‡“ xâ‚ (isVâ‚) | validá´¾-â‡“ yâ‚ (isVâ‚‚) | tiniá´¸ xâ‚ yâ‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | isVâ‚â€² | isVâ‚‚â€² | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , (Valueá´¸ â„“âŠ‘A (Ref-S âˆˆÎ²')) âŸ©
    with tiniá´¸ {{ isVâ‚â€² }} {{ isVâ‚‚â€² }} xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆâ€² âŸ© =
            let âˆˆÎ²'' = bij-âŠ† Î²'âŠ†Î²'' âˆˆÎ²'
                vâ‰ˆ = readá´¸-â‰ˆâ±½ âˆˆÎ²'' âˆˆâ‚ âˆˆâ‚‚ Î¼â‰ˆ
                Î¼â‰ˆâ€² = writeá´¸-â‰ˆá´´ Î¼â‰ˆ (â‰ˆâ±½-âŠ‘ _ vâ‰ˆâ€²) wâ‚ wâ‚‚ âˆˆÎ²'' in
                Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆâ€² âŸ© , Valueá´¸ pcâŠ‘A Unit âŸ©

  tiniá´¸  {{isVâ‚}} {{isVâ‚‚}} (Write-FS xâ‚ xâ‚‚ âˆˆâ‚ âŠ‘â‚ refl wâ‚) (Write-FS yâ‚ yâ‚‚ âˆˆâ‚‚ âŠ‘â‚‚ refl wâ‚‚) â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | isVâ‚â€² | isVâ‚‚â€² | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ â‰ˆá´¾â€² , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ©
    with tiniá´¸ {{ isVâ‚â€² }} {{ isVâ‚‚â€² }} xâ‚‚ yâ‚‚ â‰ˆá´¾â€² (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆ âŸ© , vâ‰ˆ âŸ© =
    let vâ‰ˆâ‚ = Valueá´´ (trans-â‹¤ âŠ‘â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚â‹¤A)
        vâ‰ˆâ‚‚ = Valueá´´ (trans-â‹¤ âŠ‘â‚‚ â„“â‚‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A)
        isVâ‚á´¾â€²â€² âˆ§ _ = validá´¾-â‡“ xâ‚‚ isVâ‚â€²
        isVâ‚‚á´¾â€²â€² âˆ§ _ = validá´¾-â‡“ yâ‚‚ isVâ‚‚â€²
        Î¼â‰ˆâ‚ = writeá´´-â‰ˆá´´ {{ validá´´ isVâ‚á´¾â€²â€² }} âˆˆâ‚ wâ‚ vâ‰ˆâ‚
        Î¼â‰ˆâ‚‚ = writeá´´-â‰ˆá´´ {{ validá´´ isVâ‚‚á´¾â€²â€² }} âˆˆâ‚‚ wâ‚‚ vâ‰ˆâ‚‚
        Î¼â‰ˆâ€² = square-â‰ˆá´´-Î¹ Î¼â‰ˆ  Î¼â‰ˆâ‚ Î¼â‰ˆâ‚‚ in
        Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ âŸ¨ Î£â‰ˆ , Î¼â‰ˆâ€² âŸ© , Valueá´¸ pcâŠ‘A Unit âŸ©

  -- TINI for high steps. The computations depend on a secret and thus
  -- might produce different results and code. We then prove TINI by
  -- showing that the program counter can only remain secret and that
  -- each high step preserves low-equivalence of stores and heaps.  In
  -- particular we prove that the final program state  are low-equivalent (pâ‚'
  -- â‰ˆ pâ‚‚'), i.e., the square:
  --
  -- pâ‚ â‰ˆá´¾ pâ‚'
  -- â‰ˆá´¾    â‰ˆá´¾
  -- pâ‚‚ â‰ˆá´¾ pâ‚‚'
  --
  -- using transitivity and symmetry of â‰ˆá´¾
  tiniá´´ : âˆ€ {Ï„ Î“â‚ Î“â‚‚ Î¸â‚ Î¸â‚‚ pcâ‚ pcâ‚‚ Î²} {câ‚ : IConf Î“â‚ Ï„} {câ‚‚ : IConf Î“â‚‚ Ï„} {câ‚' câ‚‚' : FConf Ï„} â†’
             let âŸ¨ Î£â‚ , Î¼â‚ , _ âŸ© = câ‚
                 âŸ¨ Î£â‚‚ , Î¼â‚‚ , _ âŸ© = câ‚‚ in
             {{validâ‚ : Valid-Inputs câ‚ Î¸â‚}} {{validâ‚‚ : Valid-Inputs câ‚‚ Î¸â‚‚}} â†’
             âŸ¨ Î£â‚ , Î¼â‚ âŸ© â‰ˆâŸ¨ Î² âŸ©á´¾ âŸ¨ Î£â‚‚ , Î¼â‚‚ âŸ© â†’
             câ‚ â‡“âŸ¨ Î¸â‚ , pcâ‚ âŸ© câ‚' â†’
             câ‚‚ â‡“âŸ¨ Î¸â‚‚ , pcâ‚‚ âŸ© câ‚‚' â†’
             pcâ‚ â‹¤ A â†’ pcâ‚‚ â‹¤ A â†’
             âˆƒ (Î» Î²' â†’ Î² âŠ† Î²' Ã— câ‚' â‰ˆâŸ¨ Î²' âŸ©á¶œ câ‚‚')
  tiniá´´ {Î² = Î²} {{isVâ‚á´¾ âˆ§ isVâ‚á´±}} {{isVâ‚‚á´¾  âˆ§ isVâ‚‚á´±}}
         â‰ˆá´¾ xâ‚ xâ‚‚ pcâ‚â‹¤A pcâ‚‚â‹¤A =
    let â‰ˆâ‚á´¾ = step-â‰ˆá´¾ {{ isVâ‚á´¾ }} {{ isVâ‚á´± }} xâ‚ pcâ‚â‹¤A
        â‰ˆâ‚‚á´¾ = step-â‰ˆá´¾ {{ isVâ‚‚á´¾ }} {{ isVâ‚‚á´± }} xâ‚‚ pcâ‚‚â‹¤A
        â‰ˆá´¾â€² = square-â‰ˆá´¾-Î¹ â‰ˆá´¾ â‰ˆâ‚á´¾ â‰ˆâ‚‚á´¾
        vâ‰ˆ = Valueá´´ (trans-â‹¤ (step-âŠ‘ xâ‚) pcâ‚â‹¤A) (trans-â‹¤ (step-âŠ‘ xâ‚‚) pcâ‚‚â‹¤A) in
        Î² âˆ§ B.refl-âŠ† âˆ§ âŸ¨ â‰ˆá´¾â€² , vâ‰ˆ âŸ©

  -- TINI: top level theorem
  tini : âˆ€ {Ï„ Î“ Î¸â‚ Î¸â‚‚ pc Î²} {câ‚ câ‚‚ : IConf Î“ Ï„} {câ‚' câ‚‚' : FConf Ï„} â†’
             {{validâ‚ : Valid-Inputs câ‚ Î¸â‚}} {{validâ‚‚ : Valid-Inputs câ‚‚ Î¸â‚‚}} â†’
             câ‚ â‡“âŸ¨ Î¸â‚ , pc âŸ© câ‚' â†’
             câ‚‚ â‡“âŸ¨ Î¸â‚‚ , pc âŸ© câ‚‚' â†’
             câ‚ â‰ˆâŸ¨ Î² âŸ©á´µ câ‚‚ â†’
             Î¸â‚ â‰ˆâŸ¨ Î² âŸ©á´± Î¸â‚‚ â†’
             âˆƒ (Î» Î²' â†’ Î² âŠ† Î²' Ã— câ‚' â‰ˆâŸ¨ Î²' âŸ©á¶œ câ‚‚')
  tini {pc = pc} xâ‚ xâ‚‚ âŸ¨ â‰ˆá´¾ , refl âŸ©  Î¸â‚â‰ˆÎ¸â‚‚ with pc âŠ‘? A
  ... | yes pcâŠ‘A = tiniá´¸ xâ‚ xâ‚‚ â‰ˆá´¾ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | no pcâ‹¤A = tiniá´´ â‰ˆá´¾ xâ‚ xâ‚‚ pcâ‹¤A pcâ‹¤A
