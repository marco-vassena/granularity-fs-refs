-- This module proves security of FG, i.e., termination-insensitive
-- non-interference (TINI).  The proof consists in showing that the
-- big-step semantics preserves L-equivalence.
--
-- This module is parametric in the security lattice ğ‘³ = (ğ“›, âŠ‘) and in
-- the attacker's security A âˆˆ ğ“›.

open import Lattice hiding (_â‰Ÿ_)

module FG.Security {{ğ‘³ : Lattice}} (A : Label) where

open import FG.Types hiding (_Ã—_) renaming (_âŠ†_ to _âŠ†á¶œ_) hiding (refl-âŠ†)
open import FG.Syntax hiding (_âˆ˜_)
open import FG.Semantics
open import FG.LowEq A as E public

open import Data.Empty
open import Relation.Binary.PropositionalEquality
open import Relation.Nullary
open import Generic.Bijection as B hiding (_âˆˆ_)

import Generic.Store.LowEq {Ty} {Raw} _â‰ˆâŸ¨_âŸ©á´¿_ as S

--------------------------------------------------------------------------------
-- TODO: move this to FG LowEq module?
-- Lemmas on L-equivalent environments.

-- Lookup in L-equivalent envs gives L-equivalent values
lookup-â‰ˆâ±½ : âˆ€ {Ï„ Î“ Î¸â‚ Î¸â‚‚ Î²} â†’ (Ï„âˆˆÎ“ : Ï„ âˆˆ Î“) â†’
              Î¸â‚ â‰ˆâŸ¨ Î² âŸ©á´± Î¸â‚‚ â†’ (Î¸â‚ !! Ï„âˆˆÎ“) â‰ˆâŸ¨ Î² âŸ©â±½ (Î¸â‚‚ !! Ï„âˆˆÎ“)
lookup-â‰ˆâ±½ here (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚) = vâ‚â‰ˆvâ‚‚
lookup-â‰ˆâ±½ (there Ï„âˆˆÎ“) (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚) = lookup-â‰ˆâ±½ Ï„âˆˆÎ“ Î¸â‚â‰ˆÎ¸â‚‚


-- Slicing L-equivalent envs gives gives L-equivalent envs.
slice-â‰ˆá´± : âˆ€ {Î“â‚ Î“â‚‚ Î²} {Î¸â‚ Î¸â‚‚ : Env Î“â‚‚} â†’
                 Î¸â‚ â‰ˆâŸ¨ Î² âŸ©á´± Î¸â‚‚ â†’
                 (Î“â‚âŠ†Î“â‚‚ : Î“â‚ âŠ†á¶œ Î“â‚‚) â†’
                 slice Î¸â‚ Î“â‚âŠ†Î“â‚‚ â‰ˆâŸ¨ Î² âŸ©á´± slice Î¸â‚‚ Î“â‚âŠ†Î“â‚‚
slice-â‰ˆá´± [] base = []
slice-â‰ˆá´± (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚) (cons p) = vâ‚â‰ˆvâ‚‚ âˆ· slice-â‰ˆá´± Î¸â‚â‰ˆÎ¸â‚‚ p
slice-â‰ˆá´± (vâ‚â‰ˆvâ‚‚ âˆ· Î¸â‚â‰ˆÎ¸â‚‚) (drop p) = slice-â‰ˆá´± Î¸â‚â‰ˆÎ¸â‚‚ p

--------------------------------------------------------------------------------

open import Data.Product renaming (_,_ to _âˆ§_) hiding (,_)


open import FG.Valid
open import Generic.Store.Valid Ty Raw âˆ¥_âˆ¥á´¿ as V
open Conf
open import Data.Nat hiding (_^_)
open import Data.Nat.Properties

-- TODO: trans-â‹¤ (join-âŠ‘ ...) proofs are simplified by join-â‹¤â‚

step-â‰ˆË¢ : âˆ€ {Ï„ Î“ Î¸ pc} {c : IConf Î“ Ï„} {c' : FConf Ï„} â†’
             let âŸ¨ Î£ , _ âŸ© = c
                 âŸ¨ Î£' , _ âŸ© = c' in
                {{validË¢ : ValidË¢ Î£}} {{validá´± : Validá´± Î£ Î¸}} â†’
               c â‡“âŸ¨ Î¸ , pc âŸ© c' â†’
               pc â‹¤ A â†’
               Î£ â‰ˆâŸ¨ Î¹ âˆ¥ Î£ âˆ¥ âŸ©Ë¢ Î£'
step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Var Ï„âˆˆÎ“ x) pcâ‹¤A = refl-â‰ˆË¢ {{isVâ‚}}
step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} Unit pcâ‹¤A = refl-â‰ˆË¢ {{isVâ‚}}
step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Lbl â„“) pcâ‹¤A = refl-â‰ˆË¢ {{isVâ‚}}

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Testâ‚ x xâ‚ â„“âŠ‘ refl) pcâ‹¤A =
  let isVá´± âˆ§ isVâ‚â€² âˆ§ isVâ‚‚â€² = valid-invariant x âŸ¨ isVâ‚ , isVâ‚‚ âŸ©
      Î£âŠ†Î£â‚ = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A
      Î£â‚âŠ†Î£â‚‚ = step-â‰ˆË¢ {{ isVâ‚â€² }} {{ isVá´± }} xâ‚ pcâ‹¤A
  in trans-â‰ˆË¢-Î¹ Î£âŠ†Î£â‚ Î£â‚âŠ†Î£â‚‚

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Testâ‚‚ x xâ‚ â„“âŠ‘ refl) pcâ‹¤A =
  let isVá´± âˆ§ isVâ‚â€² âˆ§ isVâ‚‚â€² = valid-invariant x âŸ¨ isVâ‚ , isVâ‚‚ âŸ©
      Î£âŠ†Î£â‚ = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A
      Î£â‚âŠ†Î£â‚‚ = step-â‰ˆË¢ {{ isVâ‚â€² }} {{ isVá´± }} xâ‚ pcâ‹¤A
  in trans-â‰ˆË¢-Î¹ Î£âŠ†Î£â‚ Î£â‚âŠ†Î£â‚‚

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} Fun pcâ‹¤A = refl-â‰ˆË¢ {{isVâ‚}}
step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (App {Î¸' = Î¸'} x xâ‚ refl xâ‚ƒ) pcâ‹¤A =
  let isVá´± âˆ§ isVâ‚â€² âˆ§ isVâ‚‚â€² = valid-invariant x âŸ¨ isVâ‚ , isVâ‚‚ âŸ©
      isVá´±â€² âˆ§ isVâ‚â€²â€² âˆ§ isVâ‚‚â€²â€² = valid-invariant xâ‚ âŸ¨ isVâ‚â€² , isVá´± âŸ©
      Î£âŠ†Î£â‚ = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A
      Î£â‚âŠ†Î£â‚‚ = step-â‰ˆË¢ {{ isVâ‚â€² }} {{ isVá´± }} xâ‚ pcâ‹¤A
      isVá´±â€²â€² = validá´±-âŠ† {Î¸ = Î¸'} (step-âŠ† xâ‚) isVâ‚‚â€²
      Î£â‚‚âŠ†Î£â‚ƒ = step-â‰ˆË¢ {{ isVâ‚â€²â€² }} {{ isVâ‚‚â€²â€² âˆ§ isVá´±â€²â€² }} xâ‚ƒ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤A)
  in trans-â‰ˆË¢-Î¹ Î£âŠ†Î£â‚ (trans-â‰ˆË¢-Î¹ Î£â‚âŠ†Î£â‚‚ Î£â‚‚âŠ†Î£â‚ƒ)

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Wken p x) pcâ‹¤A = step-â‰ˆË¢ {{ isVâ‚ }} {{ validá´±-âŠ†á¶œ p isVâ‚‚ }} x pcâ‹¤A

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Inl x) pcâ‹¤A = step-â‰ˆË¢ {{ isVâ‚ }} {{ isVâ‚‚ }} x pcâ‹¤A

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Inr x) pcâ‹¤A = step-â‰ˆË¢ {{ isVâ‚ }} {{ isVâ‚‚ }} x pcâ‹¤A

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Caseâ‚ x refl xâ‚) pcâ‹¤A =
  let isVá´± âˆ§ isVâ‚â€² âˆ§ isVâ‚‚â€² = valid-invariant x âŸ¨ isVâ‚ , isVâ‚‚ âŸ©
      Î£âŠ†Î£â‚ = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A
      Î£â‚âŠ†Î£â‚‚ = step-â‰ˆË¢ {{ isVâ‚â€² }} {{ isVâ‚‚â€² âˆ§ isVá´± }} xâ‚ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤A)
  in trans-â‰ˆË¢-Î¹ Î£âŠ†Î£â‚ Î£â‚âŠ†Î£â‚‚

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Caseâ‚‚ x refl xâ‚) pcâ‹¤A =
  let isVá´± âˆ§ isVâ‚â€² âˆ§ isVâ‚‚â€² = valid-invariant x âŸ¨ isVâ‚ , isVâ‚‚ âŸ©
      Î£âŠ†Î£â‚ = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A
      Î£â‚âŠ†Î£â‚‚ = step-â‰ˆË¢ {{ isVâ‚â€² }} {{ isVâ‚‚â€² âˆ§ isVá´± }} xâ‚ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤A)
  in trans-â‰ˆË¢-Î¹ Î£âŠ†Î£â‚ Î£â‚âŠ†Î£â‚‚

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Pair x xâ‚) pcâ‹¤A =
  let isVá´± âˆ§ isVâ‚â€² âˆ§ isVâ‚‚â€² = valid-invariant x âŸ¨ isVâ‚ , isVâ‚‚ âŸ©
      Î£âŠ†Î£â‚ = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A
      Î£â‚âŠ†Î£â‚‚ = step-â‰ˆË¢ {{ isVâ‚â€² }} {{ isVá´± }} xâ‚ pcâ‹¤A
  in trans-â‰ˆË¢-Î¹ Î£âŠ†Î£â‚ Î£â‚âŠ†Î£â‚‚

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Fst x refl) pcâ‹¤A = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Snd x xâ‚) pcâ‹¤A = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A
step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (LabelOf x) pcâ‹¤A = step-â‰ˆË¢ {{ isVâ‚ }} {{ isVâ‚‚ }} x pcâ‹¤A
step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} GetLabel pcâ‹¤A = refl-â‰ˆË¢ {{isVâ‚}}
step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Taint refl x xâ‚ pc'âŠ‘pc'') pcâ‹¤A =
  let isVá´± âˆ§ isVâ‚â€² âˆ§ isVâ‚‚â€² = valid-invariant x âŸ¨ isVâ‚ , isVâ‚‚ âŸ©
      Î£âŠ†Î£â‚ = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A
      Î£â‚âŠ†Î£â‚‚ = step-â‰ˆË¢ {{ isVâ‚â€² }} {{ isVá´± }} xâ‚ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤A)
  in trans-â‰ˆË¢-Î¹ Î£âŠ†Î£â‚ Î£â‚âŠ†Î£â‚‚

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (LabelOfRef x eq) pcâ‹¤A = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A
step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (New x) pcâ‹¤A = snoc-â‰ˆË¢ _ (step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} x pcâ‹¤A)
step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Read x xâ‚ eq) pcâ‹¤A = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A
step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Write {â„“ = â„“} {n = n} {Ï„ = Ï„} x âŠ‘â‚ xâ‚ âŠ‘â‚‚ w) pcâ‹¤A =
  let isVá´± âˆ§ isVâ‚â€² âˆ§ isVâ‚‚â€² = valid-invariant x âŸ¨ isVâ‚ , isVâ‚‚ âŸ©
      isVá´±â€² âˆ§ isVâ‚â€²â€² âˆ§ isVâ‚‚â€²â€² = valid-invariant xâ‚ âŸ¨ isVâ‚â€² , isVá´± âŸ©
      ref âˆ§ âˆˆâ‚‚ = validá´¿-âŠ† {r = Refá´µ {Ï„ = Ï„} â„“ n} (step-âŠ† xâ‚) isVâ‚‚â€²
      Î£âŠ†Î£â‚ = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A
      Î£â‚âŠ†Î£â‚‚ = step-â‰ˆË¢ {{ isVâ‚â€² }} {{ isVá´± }} xâ‚ pcâ‹¤A
      â„“â‹¤A = trans-â‹¤ (trans-âŠ‘ (step-âŠ‘ x) âŠ‘â‚) pcâ‹¤A
      câ‰ˆc' = S.âŒ S.cellá´´ â„“â‹¤A  â„“â‹¤A âŒŸ
      Î£â‚‚â‰ˆÎ£â‚ƒ = writeá´´-â‰ˆË¢ {{ isVâ‚â€²â€²â€„ }} âˆˆâ‚‚ w câ‰ˆc'
  in trans-â‰ˆË¢-Î¹ Î£âŠ†Î£â‚ (trans-â‰ˆË¢-Î¹ Î£â‚âŠ†Î£â‚‚ Î£â‚‚â‰ˆÎ£â‚ƒ)

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (LabelOfRef-FS x xâ‚ eq) pcâ‹¤A = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A
step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (New-FS x) pcâ‹¤A = snoc-â‰ˆË¢ _ (step-â‰ˆË¢ {{ isVâ‚ }} {{ isVâ‚‚ }} x pcâ‹¤A)
step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Read-FS x xâ‚ eq) pcâ‹¤A = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Write-FS {â„“ = â„“} {â„“â‚} {â„“â‚‚} {â„“â‚‚'} x xâ‚ âˆˆâ‚ âŠ‘â‚ refl w) pcâ‹¤A =
  let isVá´± âˆ§ isVâ‚â€² âˆ§ isVâ‚‚â€² = valid-invariant x âŸ¨ isVâ‚ , isVâ‚‚ âŸ©
      isVá´±â€² âˆ§ isVâ‚â€²â€² âˆ§ isVâ‚‚â€²â€² = valid-invariant xâ‚ âŸ¨ isVâ‚â€² , isVá´± âŸ©
      Î£âŠ†Î£â‚ = step-â‰ˆË¢ {{ isVâ‚ }} x pcâ‹¤A
      Î£â‚âŠ†Î£â‚‚ = step-â‰ˆË¢ {{ isVâ‚â€² }} {{ isVá´± }} xâ‚ pcâ‹¤A
      câ‰ˆc' = S.âŒ S.cellá´´ (trans-â‹¤ (trans-âŠ‘ (step-âŠ‘ x) âŠ‘â‚) pcâ‹¤A) (join-â‹¤â‚ (trans-â‹¤ (step-âŠ‘ x) pcâ‹¤A)) âŒŸ
      Î£â‚‚â‰ˆÎ£â‚ƒ = writeá´´-â‰ˆË¢ {{ isVâ‚â€²â€² }} âˆˆâ‚ w câ‰ˆc'
  in trans-â‰ˆË¢-Î¹ Î£âŠ†Î£â‚ (trans-â‰ˆË¢-Î¹ Î£â‚âŠ†Î£â‚‚ Î£â‚‚â‰ˆÎ£â‚ƒ )

step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (Id x) pcâ‹¤A = step-â‰ˆË¢ {{ isVâ‚ }} {{ isVâ‚‚ }} x pcâ‹¤A
step-â‰ˆË¢ {{isVâ‚}} {{isVâ‚‚}} (UnId x eq) pcâ‹¤A = step-â‰ˆË¢ {{ isVâ‚ }} {{ isVâ‚‚ }} x pcâ‹¤A

--------------------------------------------------------------------------------

open _â‰ˆâŸ¨_,_âŸ©á´¬_
open import Data.Unit hiding (_â‰Ÿ_)
open import Generic.Heap ğ‘¯
-- open SecurityLattice ğ‘³
open import Generic.LValue
open HasLabel ğ‘¯ -- import Generic.LValue as H

wken-âˆƒ : âˆ€ {Ï„ Î² Î²'} {câ‚ câ‚‚ : FConf Ï„} â†’
         Î² âŠ† Î²' â†’ (x : âˆƒ (Î» Î²'' â†’ Î²' âŠ† Î²'' Ã— câ‚ â‰ˆâŸ¨ Î²'' âŸ©á¶œ câ‚‚)) â†’
         âˆƒ (Î» Î²'' â†’ Î² âŠ† Î²'' Ã— câ‚ â‰ˆâŸ¨ Î²'' âŸ©á¶œ câ‚‚)
wken-âˆƒ Î²âŠ†Î²' (Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ â‰ˆâ‚)  = Î²'' âˆ§ (trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'') âˆ§ â‰ˆâ‚

mutual

  -- TINI for low steps
  tiniá´¸ : âˆ€ {pc Î² Ï„ Î“ Î£â‚ Î£â‚‚ e} {Î¸â‚ Î¸â‚‚ : Env Î“} {câ‚' câ‚‚' : FConf Ï„} â†’
                    let câ‚ = âŸ¨ Î£â‚ ,  e âŸ©
                        câ‚‚ = âŸ¨ Î£â‚‚ ,  e âŸ© in
                    câ‚ â‡“âŸ¨ Î¸â‚ , pc âŸ© câ‚' â†’
                    câ‚‚ â‡“âŸ¨ Î¸â‚‚ , pc âŸ© câ‚‚' â†’
                    Î£â‚ â‰ˆâŸ¨ Î² âŸ©Ë¢ Î£â‚‚ â†’
                    Î¸â‚ â‰ˆâŸ¨ Î² âŸ©á´± Î¸â‚‚ â†’
                    pc âŠ‘ A â†’
                    âˆƒ (Î» Î²' â†’ Î² âŠ† Î²' Ã— câ‚' â‰ˆâŸ¨ Î²' âŸ©á¶œ câ‚‚')
  tiniá´¸ (Var Ï„âˆˆÎ“ refl) (Var .Ï„âˆˆÎ“ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ Î£â‚â‰ˆÎ£â‚‚ , â‰ˆâ±½-âŠ‘ _ vâ‚â‰ˆvâ‚‚ âŸ©
    where vâ‚â‰ˆvâ‚‚ = lookup-â‰ˆâ±½ Ï„âˆˆÎ“ Î¸â‚â‰ˆÎ¸â‚‚

  tiniá´¸ Unit Unit Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ Î£â‚â‰ˆÎ£â‚‚ , Valueá´¸ pcâŠ‘A Unit âŸ©

  tiniá´¸ (Lbl â„“) (Lbl .â„“) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ Î£â‚â‰ˆÎ£â‚‚ , Valueá´¸ pcâŠ‘A (Lbl â„“) âŸ©

  -- Both true
  tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨  Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ _ (Lbl â„“â‚) âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A

  tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
      = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´¸ (join-âŠ‘' pâ‚ pâ‚‚) (Trueá´¸ pcâŠ‘A) âŸ©

  tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ p (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
      = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚‚) âŸ©

  tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... |  Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , vâ‰ˆ âŸ©
    = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚' ) (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚‚' ) âŸ©

    -- True vs False
  tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | _ âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ _ (Lbl â„“â‚) âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A

  tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | _ âˆ§ _ âˆ§  âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | _ âˆ§ _ âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
      = âŠ¥-elim (â„“â‚â‹¤â„“â‚‚ â„“â‚âŠ‘â„“â‚‚)

  tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ p (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
      = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚‚) âŸ©

  tiniá´¸ (Testâ‚ xâ‚ xâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚' ) (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚‚' ) âŸ©

  -- False vs True
  tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | _ âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ _ (Lbl â„“â‚) âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A

  tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | _ âˆ§ _ âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | _ âˆ§ _ âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
      = âŠ¥-elim (â„“â‚â‹¤â„“â‚‚ â„“â‚âŠ‘â„“â‚‚)

  tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ p (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
    = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚‚) âŸ©

  tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚ yâ‚ yâ‚‚ â„“â‚âŠ‘â„“â‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚' ) (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚‚' ) âŸ©


  -- False and False
  tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ yâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ _ (Lbl â„“â‚) âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A

  tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ pâ‚ (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´¸ pâ‚‚ (Lbl â„“â‚‚) âŸ©
      = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´¸ (join-âŠ‘' pâ‚ pâ‚‚) (Falseá´¸ pcâŠ‘A) âŸ©

  tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ p (Lbl â„“â‚) âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ Â¬pâ‚ Â¬pâ‚‚ âŸ©
      = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) Â¬pâ‚‚) âŸ©

  tiniá´¸ (Testâ‚‚ xâ‚ xâ‚‚ â„“â‚â‹¤â„“â‚‚ refl) (Testâ‚‚ yâ‚ yâ‚‚ _ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ pcâ‹¤â„“â‚' pcâ‹¤â„“â‚‚' âŸ© with tiniá´¸ xâ‚‚ yâ‚‚ Î£â‚'â‰ˆÎ£â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , vâ‰ˆ âŸ©
    = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚ƒâ‰ˆÎ£â‚ƒ' , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚' ) (trans-â‹¤ (join-âŠ‘â‚ _ _) pcâ‹¤â„“â‚‚' ) âŸ©

  tiniá´¸ Fun Fun Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ Î£â‚â‰ˆÎ£â‚‚ , Valueá´¸ pcâŠ‘A (Fun Î¸â‚â‰ˆÎ¸â‚‚) âŸ©

  tiniá´¸ (App x xâ‚ eqâ‚ xâ‚ƒ) (App xâ‚„ xâ‚… eqâ‚‚ xâ‚‡) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚„ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , vâ‚â‰ˆvâ‚‚ âŸ© with tiniá´¸ xâ‚ xâ‚… Î£â‚'â‰ˆÎ£â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  tiniá´¸ (App x xâ‚ eqâ‚ xâ‚ƒ) (App xâ‚„ xâ‚… eqâ‚‚ xâ‚‡) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , E.Valueá´¸ pcâŠ‘â„“' (Fun Î¸â‚'â‰ˆÎ¸â‚‚') âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚''â‰ˆÎ£â‚‚'' , vâ‚'â‰ˆvâ‚‚' âŸ©
      rewrite eqâ‚ | eqâ‚‚ = wken-âˆƒ (trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'') (tini {{ {!!} }} {{ {!!} }} xâ‚ƒ xâ‚‡  âŸ¨ Î£â‚''â‰ˆÎ£â‚‚'' , refl âŸ© (vâ‚'â‰ˆvâ‚‚' âˆ· wken-â‰ˆá´± Î²'âŠ†Î²'' Î¸â‚'â‰ˆÎ¸â‚‚' ))

  tiniá´¸ (App x xâ‚ eqâ‚ xâ‚ƒ) (App xâ‚„ xâ‚… eqâ‚‚ xâ‚‡) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , E.Valueá´´ pcâ‹¤â„“â‚ pcâ‹¤â„“â‚‚ âŸ© | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚''â‰ˆÎ£â‚‚'' , vâ‚'â‰ˆvâ‚‚' âŸ©
      rewrite eqâ‚ | eqâ‚‚ =  wken-âˆƒ (trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'') (tiniá´´ {{ {!!} }} {{ {!!} }} Î£â‚''â‰ˆÎ£â‚‚'' xâ‚ƒ xâ‚‡ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) pcâ‹¤â„“â‚) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) pcâ‹¤â„“â‚‚))

  tiniá´¸ (Wken p x) (Wken .p xâ‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = tiniá´¸ x xâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚â€² pcâŠ‘A
    where Î¸â‚â‰ˆÎ¸â‚‚â€² = slice-â‰ˆá´± Î¸â‚â‰ˆÎ¸â‚‚ p

  tiniá´¸ (Inl x) (Inl xâ‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , vâ‚â‰ˆvâ‚‚ âŸ© =  Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ pcâŠ‘A (Inl vâ‚â‰ˆvâ‚‚) âŸ©

  tiniá´¸ (Inr x) (Inr xâ‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , vâ‚â‰ˆvâ‚‚ âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ pcâŠ‘A (Inr vâ‚â‰ˆvâ‚‚) âŸ©

  tiniá´¸ (Caseâ‚ x refl xâ‚‚) (Caseâ‚ xâ‚ƒ refl xâ‚…) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ƒ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A (Inl vâ‚â‰ˆvâ‚‚) âŸ© = wken-âˆƒ Î²âŠ†Î²' (tini {{ {!!} }} {{ {!!} }} xâ‚‚ xâ‚… âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , refl âŸ© (vâ‚â‰ˆvâ‚‚ âˆ· wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚))
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ {!!} }} {{ {!!} }} Î£â‚'â‰ˆÎ£â‚‚' xâ‚‚ xâ‚… (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A))

  tiniá´¸ (Caseâ‚ x refl xâ‚‚) (Caseâ‚‚ xâ‚ƒ refl xâ‚…) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ƒ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A () âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ {!!} }} {{ {!!} }} Î£â‚'â‰ˆÎ£â‚‚' xâ‚‚ xâ‚… (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A))

  tiniá´¸ (Caseâ‚‚ x refl xâ‚‚) (Caseâ‚ xâ‚ƒ refl xâ‚…) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ƒ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A () âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ {!!} }} {{ {!!} }} Î£â‚'â‰ˆÎ£â‚‚' xâ‚‚ xâ‚… (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A))

  tiniá´¸ (Caseâ‚‚ x refl xâ‚‚) (Caseâ‚‚ xâ‚ƒ refl xâ‚…) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ƒ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A (Inr vâ‚â‰ˆvâ‚‚) âŸ© = wken-âˆƒ Î²âŠ†Î²' (tini {{ {!!} }} {{ {!!} }} xâ‚‚ xâ‚… âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , refl âŸ© (vâ‚â‰ˆvâ‚‚ âˆ· wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚))
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ {!!} }} {{ {!!} }} Î£â‚'â‰ˆÎ£â‚‚' xâ‚‚ xâ‚… (join-â‹¤â‚‚ â„“â‚â‹¤A) (join-â‹¤â‚‚ â„“â‚‚â‹¤A))

  tiniá´¸ (Pair x xâ‚) (Pair xâ‚‚ xâ‚ƒ) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , vâ‚â‰ˆvâ‚' âŸ© with tiniá´¸ xâ‚ xâ‚ƒ Î£â‚'â‰ˆÎ£â‚‚' (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚''â‰ˆÎ£â‚‚'' , vâ‚‚â‰ˆvâ‚‚' âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‚''â‰ˆÎ£â‚‚'' , Valueá´¸ pcâŠ‘A (Pair (wken-â‰ˆâ±½ Î²'âŠ†Î²'' vâ‚â‰ˆvâ‚') vâ‚‚â‰ˆvâ‚‚') âŸ©

  tiniá´¸ (Fst x refl) (Fst xâ‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A (Pair vâ‚â‰ˆvâ‚' vâ‚‚â‰ˆvâ‚‚') âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , â‰ˆâ±½-âŠ‘ _ vâ‚â‰ˆvâ‚' âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

  tiniá´¸ (Snd x refl) (Snd xâ‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A (Pair vâ‚â‰ˆvâ‚' vâ‚‚â‰ˆvâ‚‚') âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , â‰ˆâ±½-âŠ‘ _ vâ‚‚â‰ˆvâ‚‚' âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

  tiniá´¸ (LabelOf x) (LabelOf xâ‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ x xâ‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A vâ‚â‰ˆvâ‚‚ âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´¸ â„“âŠ‘A (Lbl _) âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ©

  tiniá´¸ GetLabel GetLabel Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A = _ âˆ§ refl-âŠ† âˆ§ âŸ¨ Î£â‚â‰ˆÎ£â‚‚ , Valueá´¸ pcâŠ‘A (Lbl _) âŸ©

  tiniá´¸ (Taint refl xâ‚ xâ‚‚ pc'âŠ‘pc'') (Taint refl xâ‚ƒ xâ‚„ pc'âŠ‘pc''') Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚ƒ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , E.Valueá´¸ â„“âŠ‘A (E.Lbl â„“) âŸ© = wken-âˆƒ Î²âŠ†Î²' ( tini {{ {!!} }} {{ {!!} }} xâ‚‚ xâ‚„ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , refl âŸ© (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚))
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© =  wken-âˆƒ Î²âŠ†Î²' (tiniá´´ {{ {!!} }} {{ {!!} }} Î£â‚'â‰ˆÎ£â‚‚' xâ‚‚ xâ‚„ (trans-â‹¤ pc'âŠ‘pc'' â„“â‚â‹¤A) (trans-â‹¤ pc'âŠ‘pc''' â„“â‚‚â‹¤A))

  tiniá´¸ (LabelOfRef xâ‚ refl) (LabelOfRef xâ‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (E.Ref-Iá´¸ â„“âŠ‘Aâ‚ n) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , (Valueá´¸ (join-âŠ‘' â„“âŠ‘Aâ‚ â„“âŠ‘A) (Lbl _)) âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (E.Ref-Iá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , (Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚â‹¤A) (trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚‚â‹¤A)) âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , E.Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) â„“â‚â‹¤A) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) â„“â‚‚â‹¤A) âŸ©

  tiniá´¸  {pc = pc} {Î£â‚ = Î£â‚} {Î£â‚‚ = Î£â‚‚} (New {â„“ = â„“â‚} {Ï„ = Ï„} {Î£' = Î£â‚'} {r = râ‚} xâ‚) (New {â„“ = â„“â‚‚} {Î£' = Î£â‚‚'} {r = râ‚‚} xâ‚‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , vâ‰ˆ  âŸ© = Î²'' âˆ§ Î²âŠ†Î²'' âˆ§ E.âŸ¨ Î£â‰ˆâ€² , vâ‰ˆâ€² âŸ©
      where instance _ = _â‰Ÿ_
                     _ = â‰ˆ-# Î£â‰ˆ
            Î²â‚ =  âˆ¥ Î£â‚' âˆ¥ â†” âˆ¥ Î£â‚‚' âˆ¥
            Î²'' = Î²' âˆ£á´® Î²â‚
            Î²'âŠ†Î²'' = âˆ£á´®-âŠ†â‚ Î²' Î²â‚
            Î²âŠ†Î²'' = trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²''
            Î£â‰ˆâ€² = newá´¸-â‰ˆË¢ (â‰ˆâ±½-â‰ˆá¶œ vâ‰ˆ) Î£â‰ˆ
            vâ‰ˆâ€² = Valueá´¸ pcâŠ‘A (Ref-Iâ€² (bij-âŠ† (âˆ£á´®-âŠ†â‚‚ Î²' Î²â‚) (â†”-âˆˆáµ— âˆ¥ Î£â‚' âˆ¥ âˆ¥ Î£â‚‚' âˆ¥)) (wken-â‰ˆâ±½ Î²'âŠ†Î²'' vâ‰ˆ))

  tiniá´¸ (Read xâ‚ nâˆˆMâ‚ refl) (Read xâ‚‚ nâˆˆMâ‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨  Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (Ref-Iá´¸ â„“'âŠ‘A x) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , â‰ˆâ±½-âŠ‘ _ vâ‰ˆ âŸ©
       where vâ‰ˆ = â‰ˆá¶œ-â‰ˆâ±½ (readá´¸-â‰ˆá¶œ x nâˆˆMâ‚ nâˆˆMâ‚‚ Î£â‰ˆ)

  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (Ref-Iá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , vâ‰ˆ âŸ©
    where vâ‰ˆ = Valueá´´ (trans-â‹¤ (join-âŠ‘â‚‚ _ _) â„“â‚â‹¤A) (trans-â‹¤ (join-âŠ‘â‚‚ _ _) â„“â‚‚â‹¤A)

  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , E.Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , vâ‰ˆ âŸ©
    where vâ‰ˆ = Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚â‹¤A) (trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚‚â‹¤A)

  tiniá´¸ (Write {â„“ = â„“â‚} xâ‚ âŠ‘â‚ yâ‚ â„“â‚‚âŠ‘â„“ wâ‚) (Write {â„“ = â„“â‚‚} xâ‚‚ âŠ‘â‚‚ yâ‚‚ â„“â‚‚âŠ‘â„“' wâ‚‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A

  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , E.Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© with tiniá´¸ yâ‚ yâ‚‚ Î£â‰ˆ (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ E.âŸ¨ Î£â‰ˆâ€² , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ E.âŸ¨ Î£â‰ˆâ€²â€² , Valueá´¸ pcâŠ‘A Unit âŸ©
    where
          postulate valid-refâ‚ : Validá´¿ _ (Refá´µ â„“â‚ _)
          postulate valid-refâ‚‚ : Validá´¿ _ (Refá´µ â„“â‚‚ _)
          câ‰ˆâ‚ = âŒ cellá´´ (trans-â‹¤ âŠ‘â‚ â„“â‚â‹¤A ) (trans-â‹¤ âŠ‘â‚ â„“â‚â‹¤A) âŒŸ
          câ‰ˆâ‚‚ = âŒ cellá´´ (trans-â‹¤ âŠ‘â‚‚ â„“â‚‚â‹¤A ) (trans-â‹¤ âŠ‘â‚‚ â„“â‚‚â‹¤A) âŒŸ
          Î£â‰ˆâ€²â€² = square-â‰ˆË¢-Î¹ Î£â‰ˆâ€² (writeá´´-â‰ˆË¢ {{ {!!} }} (projâ‚‚ valid-refâ‚) wâ‚ câ‰ˆâ‚)
                                 (writeá´´-â‰ˆË¢ {{ {!!} }} (projâ‚‚ valid-refâ‚‚) wâ‚‚ câ‰ˆâ‚‚)

  tiniá´¸ (Write xâ‚ â„“'âŠ‘â„“ yâ‚ â„“â‚‚âŠ‘â„“ wâ‚) (Write xâ‚‚ â„“'âŠ‘â„“' yâ‚‚ â„“â‚‚âŠ‘â„“' wâ‚‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²'  âˆ§ E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (Ref-Iá´¸ âŠ‘â€² âˆˆÎ²') âŸ© with tiniá´¸ yâ‚ yâ‚‚ Î£â‰ˆ (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ E.âŸ¨ Î£â‰ˆâ€² , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‰ˆâ€²â€² , Valueá´¸ pcâŠ‘A Unit âŸ©
    where âˆˆÎ²'' = bij-âŠ† Î²'âŠ†Î²'' âˆˆÎ²'
          Î£â‰ˆâ€²â€² = writeá´¸-â‰ˆË¢ Î£â‰ˆâ€² (â‰ˆâ±½-â‰ˆá¶œ (Valueá´¸ âŠ‘â€² (extract-â‰ˆá´¿ vâ‰ˆ (trans-âŠ‘ â„“â‚‚âŠ‘â„“ âŠ‘â€²)))) wâ‚ wâ‚‚ âˆˆÎ²''

  tiniá´¸ (Write xâ‚ âŠ‘â‚ yâ‚ âŠ‘â‚â€² wâ‚) (Write xâ‚‚ âŠ‘â‚‚ yâ‚‚ âŠ‘â‚‚â€² wâ‚‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
    | Î²' âˆ§ Î²âŠ†Î²'  âˆ§ E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (Ref-Iá´´ â‹¤â‚ â‹¤â‚‚) âŸ© with tiniá´¸ yâ‚ yâ‚‚ Î£â‰ˆ (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ E.âŸ¨ Î£â‰ˆâ€² , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‰ˆâ€²â€² , Valueá´¸ pcâŠ‘A Unit âŸ©
      where postulate valid-refâ‚ : Validá´¿ _ (Refá´µ _ _)
            postulate valid-refâ‚‚ : Validá´¿ _ (Refá´µ _ _)
            câ‰ˆâ‚ = âŒ cellá´´ â‹¤â‚ â‹¤â‚ âŒŸ
            câ‰ˆâ‚‚ = âŒ cellá´´ â‹¤â‚‚ â‹¤â‚‚ âŒŸ
            Î£â‰ˆâ€²â€² = square-â‰ˆË¢-Î¹ Î£â‰ˆâ€² (writeá´´-â‰ˆË¢ {{ {!!} }} (projâ‚‚ valid-refâ‚) wâ‚ câ‰ˆâ‚) (writeá´´-â‰ˆË¢ {{ {!!} }} (projâ‚‚ valid-refâ‚‚) wâ‚‚ câ‰ˆâ‚‚)

  tiniá´¸ (Id xâ‚) (Id xâ‚‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with  tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , vâ‰ˆ âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , Valueá´¸ pcâŠ‘A (E.Id vâ‰ˆ) âŸ©

  tiniá´¸ (UnId xâ‚ refl) (UnId xâ‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (Id vâ‰ˆ) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , â‰ˆâ±½-âŠ‘ _ vâ‰ˆ âŸ©
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , E.Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

  tiniá´¸ (LabelOfRef-FS xâ‚ âˆˆâ‚ refl) (LabelOfRef-FS xâ‚‚ âˆˆâ‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (Ref-S âˆˆÎ²') âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , vâ‰ˆ âŸ©
    where vâ‰ˆ = â‰ˆâ±½-âŠ‘ _ (label-ofâ‰ˆá¶œ-â‰ˆâ±½ (readá´¸-â‰ˆá¶œ âˆˆÎ²' âˆˆâ‚ âˆˆâ‚‚ Î£â‰ˆ))
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , E.Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , Valueá´´ (join-â‹¤â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŸ©

  tiniá´¸ (New-FS {Î£' = Î£â‚'} xâ‚) (New-FS {Î£' = Î£â‚‚'} xâ‚‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , vâ‰ˆ  âŸ© = Î²'' âˆ§ Î²âŠ†Î²'' âˆ§ E.âŸ¨ Î£â‰ˆâ€² , wken-â‰ˆâ±½ (âˆ£á´®-âŠ†â‚‚ Î²' Î²â‚) vâ‰ˆâ€² âŸ©
      where instance _ = _â‰Ÿ_
                     _ = â‰ˆ-# Î£â‰ˆ
            Î²â‚ =  âˆ¥ Î£â‚' âˆ¥ â†” âˆ¥ Î£â‚‚' âˆ¥
            Î²'' = Î²' âˆ£á´® Î²â‚
            Î²'âŠ†Î²'' = âˆ£á´®-âŠ†â‚ Î²' Î²â‚
            Î²âŠ†Î²'' = trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²''
            Î£â‰ˆâ€² = newá´¸-â‰ˆË¢ (â‰ˆâ±½-â‰ˆá¶œ vâ‰ˆ) Î£â‰ˆ
            vâ‰ˆâ€² = Valueá´¸ pcâŠ‘A (Ref-S (â†”-âˆˆáµ— âˆ¥ Î£â‚' âˆ¥ âˆ¥ Î£â‚‚' âˆ¥)) -- (Ref-Iá´¸â€² â„“âŠ‘A (projâ‚ (â†”-âˆˆ âˆ¥ Î£â‚' âˆ¥ âˆ¥ Î£â‚‚' âˆ¥)))


  tiniá´¸ (Read-FS xâ‚ âˆˆâ‚ refl) (Read-FS xâ‚‚ âˆˆâ‚‚ refl) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , E.Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , vâ‰ˆ âŸ©
    where vâ‰ˆ = Valueá´´ (trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚â‹¤A ) ((trans-â‹¤ (join-âŠ‘â‚ _ _) â„“â‚‚â‹¤A ))

  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨  Î£â‰ˆ , E.Valueá´¸ â„“âŠ‘A (Ref-S âˆˆÎ²) âŸ© = Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , â‰ˆâ±½-âŠ‘ _ vâ‰ˆ âŸ©
       where vâ‰ˆ = â‰ˆá¶œ-â‰ˆâ±½ (readá´¸-â‰ˆá¶œ âˆˆÎ² âˆˆâ‚ âˆˆâ‚‚ Î£â‰ˆ)


  tiniá´¸ (Write-FS {â„“ = â„“} {â„“â‚} {â„“â‚‚} {â„“â‚‚'} xâ‚ yâ‚ âˆˆâ‚ âŠ‘â‚ refl wâ‚) (Write-FS xâ‚‚ yâ‚‚ âˆˆâ‚‚ âŠ‘â‚‚ refl wâ‚‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A with tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , (Valueá´¸ â„“âŠ‘A (Ref-S âˆˆÎ²')) âŸ© with tiniá´¸ yâ‚ yâ‚‚ Î£â‰ˆ (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ E.âŸ¨ Î£â‰ˆâ€² , vâ‰ˆ âŸ© =
            let âˆˆÎ²'' = bij-âŠ† Î²'âŠ†Î²'' âˆˆÎ²'
                câ‰ˆ = readá´¸-â‰ˆá¶œ âˆˆÎ²'' âˆˆâ‚ âˆˆâ‚‚ Î£â‰ˆâ€²
                Î£â‰ˆâ€²â€² = writeá´¸-â‰ˆË¢ Î£â‰ˆâ€² (â‰ˆá¶œ-âŠ‘ â„“ (taint-update-â‰ˆá¶œ câ‰ˆ vâ‰ˆ)) wâ‚ wâ‚‚ âˆˆÎ²'' in Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ âŸ¨ Î£â‰ˆâ€²â€² , Valueá´¸ pcâŠ‘A Unit âŸ©

  tiniá´¸ (Write-FS {â„“ = â„“} {â„“â‚} {â„“â‚‚} {â„“â‚‚'} xâ‚ yâ‚ âˆˆâ‚ âŠ‘â‚ refl wâ‚) (Write-FS xâ‚‚ yâ‚‚ âˆˆâ‚‚ âŠ‘â‚‚ refl wâ‚‚) Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A | Î²' âˆ§ Î²âŠ†Î²' âˆ§ E.âŸ¨ Î£â‰ˆ , (Valueá´´ â„“â‚â‹¤A â„“â‚‚â‹¤A) âŸ© with tiniá´¸ yâ‚ yâ‚‚ Î£â‰ˆ (wken-â‰ˆá´± Î²âŠ†Î²' Î¸â‚â‰ˆÎ¸â‚‚) pcâŠ‘A
  ... | Î²'' âˆ§ Î²'âŠ†Î²'' âˆ§ E.âŸ¨ Î£â‰ˆâ€² , vâ‰ˆ âŸ© = Î²'' âˆ§ trans-âŠ† Î²âŠ†Î²' Î²'âŠ†Î²'' âˆ§ E.âŸ¨ Î£â‰ˆâ€²â€² , Valueá´¸ pcâŠ‘A Unit âŸ©
    where câ‰ˆâ‚ = âŒ cellá´´ (trans-â‹¤ âŠ‘â‚ â„“â‚â‹¤A) (join-â‹¤â‚ â„“â‚â‹¤A) âŒŸ
          câ‰ˆâ‚‚ = âŒ cellá´´ (trans-â‹¤ âŠ‘â‚‚ â„“â‚‚â‹¤A) (join-â‹¤â‚ â„“â‚‚â‹¤A) âŒŸ
          Î£â‰ˆâ€²â€² = square-â‰ˆË¢-Î¹ Î£â‰ˆâ€² (writeá´´-â‰ˆË¢ {{ {!!} }} âˆˆâ‚ wâ‚ câ‰ˆâ‚) (writeá´´-â‰ˆË¢ {{ {!!} }} âˆˆâ‚‚ wâ‚‚ câ‰ˆâ‚‚)


  -- TINI for high steps. The computations depend on a secret and thus
  -- might produce different results and code. We then prove TINI by
  -- showing that the program counter can only remain secret and that
  -- each high step preserves low-equivalence of stores.  In
  -- particular we prove that the final stores are low-equivalent (Î£â‚'
  -- â‰ˆ Î£â‚‚'), i.e., the square:
  --
  -- Î£â‚ â‰ˆË¢ Î£â‚'
  -- â‰ˆË¢    â‰ˆË¢
  -- Î£â‚‚ â‰ˆË¢ Î£â‚‚'
  --
  -- using transitivity and symmetry of â‰ˆË¢
  -- TODO: do the same for FS-Store
  tiniá´´ : âˆ€ {Ï„ Î“â‚ Î“â‚‚ Î¸â‚ Î¸â‚‚ pcâ‚ pcâ‚‚ Î²} {câ‚ : IConf Î“â‚ Ï„} {câ‚‚ : IConf Î“â‚‚ Ï„} {câ‚' câ‚‚' : FConf Ï„} â†’
             let âŸ¨ Î£â‚ , _ âŸ© = câ‚
                 âŸ¨ Î£â‚‚ , _ âŸ© = câ‚‚ in
             -- {{validâ‚á´µ : Validá´µ câ‚}} {{validá´± : Validá´± âˆ¥ Î£â‚ âˆ¥ Î¸â‚}} â†’
             -- {{validâ‚‚á´µ : Validá´µ câ‚‚}} {{validâ‚‚á´± : Validá´± âˆ¥ Î£â‚‚ âˆ¥ Î¸â‚‚}} â†’
             {{validâ‚ : Valid-Inputs câ‚ Î¸â‚}} {{validâ‚‚ : Valid-Inputs câ‚‚ Î¸â‚‚}} â†’
             Î£â‚ â‰ˆâŸ¨ Î² âŸ©Ë¢ Î£â‚‚ â†’
             câ‚ â‡“âŸ¨ Î¸â‚ , pcâ‚ âŸ© câ‚' â†’
             câ‚‚ â‡“âŸ¨ Î¸â‚‚ , pcâ‚‚ âŸ© câ‚‚' â†’
             pcâ‚ â‹¤ A â†’ pcâ‚‚ â‹¤ A â†’
             âˆƒ (Î» Î²' â†’ Î² âŠ† Î²' Ã— câ‚' â‰ˆâŸ¨ Î²' âŸ©á¶œ câ‚‚')
  -- Do we actually need to prove Î² âŠ† Î²' ? Not clear from Banjaree proof if this is ever used.
  -- The only reason I can think of is that the theorem might be trivial if we choose Î²' = âˆ…
  -- because we do not need to take care of the references. Check this with Deepak.
  tiniá´´ {Î² = Î²} {{âŸ¨ isVâ‚Ë¢ , isVâ‚á´± âŸ© }} {{âŸ¨ isVâ‚‚Ë¢ , isVâ‚‚á´± âŸ© }}
         Î£â‚â‰ˆÎ£â‚‚ xâ‚ xâ‚‚ pcâ‚â‹¤A pcâ‚‚â‹¤A =
    let Î£â‚â‰ˆÎ£â‚' = step-â‰ˆË¢ {{ isVâ‚Ë¢ }} {{ isVâ‚á´± }} xâ‚ pcâ‚â‹¤A
        Î£â‚‚â‰ˆÎ£â‚‚' = step-â‰ˆË¢ {{ isVâ‚‚Ë¢ }} {{ isVâ‚‚á´± }} xâ‚‚ pcâ‚‚â‹¤A
        Î£â‚'â‰ˆÎ£â‚‚' = square-â‰ˆË¢-Î¹ Î£â‚â‰ˆÎ£â‚‚ Î£â‚â‰ˆÎ£â‚' Î£â‚‚â‰ˆÎ£â‚‚'
        vâ‰ˆ = Valueá´´ (trans-â‹¤ (step-âŠ‘ xâ‚) pcâ‚â‹¤A) (trans-â‹¤ (step-âŠ‘ xâ‚‚) pcâ‚‚â‹¤A) in
        Î² âˆ§ B.refl-âŠ† âˆ§ âŸ¨ Î£â‚'â‰ˆÎ£â‚‚' , vâ‰ˆ âŸ©


  -- TINI: top level theorem
  tini : âˆ€ {Ï„ Î“ Î¸â‚ Î¸â‚‚ pc Î²} {câ‚ câ‚‚ : IConf Î“ Ï„} {câ‚' câ‚‚' : FConf Ï„} â†’
             -- {{validâ‚á´µ : Validá´µ câ‚}} {{validá´± : Validá´± âˆ¥ store câ‚ âˆ¥ Î¸â‚}} â†’
             -- {{validâ‚‚á´µ : Validá´µ câ‚‚}} {{validâ‚‚á´± : Validá´± âˆ¥ store câ‚‚ âˆ¥ Î¸â‚‚}} â†’
             {{validâ‚ : Valid-Inputs câ‚ Î¸â‚}} {{validâ‚‚ : Valid-Inputs câ‚‚ Î¸â‚‚}} â†’
             câ‚ â‡“âŸ¨ Î¸â‚ , pc âŸ© câ‚' â†’
             câ‚‚ â‡“âŸ¨ Î¸â‚‚ , pc âŸ© câ‚‚' â†’
             câ‚ â‰ˆâŸ¨ Î² âŸ©á´µ câ‚‚ â†’
             Î¸â‚ â‰ˆâŸ¨ Î² âŸ©á´± Î¸â‚‚ â†’
             âˆƒ (Î» Î²' â†’ Î² âŠ† Î²' Ã— câ‚' â‰ˆâŸ¨ Î²' âŸ©á¶œ câ‚‚')
  tini {pc = pc} xâ‚ xâ‚‚ âŸ¨ Î£â‚â‰ˆÎ£â‚‚ , refl âŸ©  Î¸â‚â‰ˆÎ¸â‚‚ with pc âŠ‘? A
  ... | yes pcâŠ‘A = tiniá´¸ xâ‚ xâ‚‚ Î£â‚â‰ˆÎ£â‚‚ Î¸â‚â‰ˆÎ¸â‚‚ pcâŠ‘A
  ... | no pcâ‹¤A = tiniá´´ Î£â‚â‰ˆÎ£â‚‚ xâ‚ xâ‚‚ pcâ‹¤A pcâ‹¤A
